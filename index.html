<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesbuildr Widget Template Tools</title>
    
    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Inline Styles -->
    <style>
        /* Global Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1, h2 {
            color: #2c3e50;
        }
        
        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab-button {
            padding: 10px 20px;
            background-color: #e0e0e0; /* Darker gray for inactive tabs */
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            color: #333; /* Dark text for better contrast on inactive tabs */
        }
        
        .tab-button:hover {
            background-color: #d0d0d0; /* Even darker on hover */
        }
        
        .tab-button.active {
            background-color: #2980b9; /* Keep the blue for active tab */
            color: white; /* White text for active tab */
            border-color: #2980b9;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Container Layout */
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Dropzone Styles */
        .dropzone {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .dropzone:hover, .dropzone.dragover {
            border-color: #3498db;
            background-color: #ecf0f1;
        }
        
        /* Options Panel */
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }
        
        label {
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        /* Buttons */
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover:not(:disabled) {
            background-color: #3498db;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        /* Progress Indicator */
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        progress {
            width: 100%;
            height: 20px;
        }
        
        /* Preview Grid */
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .preview-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-title {
            font-weight: 600;
            margin: 0;
        }
        
        .preview-image {
            display: block;
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            background-color: white;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .preview-actions {
            padding: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Status Messages */
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Log Container */
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .log-entry {
            margin: 0;
            padding: 2px 0;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.warn {
            color: #ffc107;
        }
        
        .log-entry.info {
            color: #17a2b8;
        }
        
        /* Download All Button */
        .download-all-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        /* Widget Creator Styles */
        .widget-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .url-container {
            display: flex;
            gap: 10px;
        }
        
        .url-input {
            flex-grow: 1;
        }
        
        .widget-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 10px;
        }
        
        .image-preview {
            max-width: 300px;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            object-fit: contain;
        }
        
        .widget-preview {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: white;
        }
        
        .widget-preview table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .widget-preview td {
            padding: 10px;
            vertical-align: top;
        }
        
        .code-container {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .code-content {
            max-height: 300px;
            overflow-y: auto;
            background-color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .options, .widget-options {
                flex-direction: column;
            }
            
            .preview-container {
                grid-template-columns: 1fr;
            }
            
            .url-container {
                flex-direction: column;
            }
        }


        /* Widget Container Styles */
        .widget-container {
            display: flex;
            flex-wrap: wrap;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }


        .widget-container.vertical {
            flex-direction: column;
        }


        .widget-image-left, .widget-image-right {
            flex: 0 0 40%;
            max-height: 300px;
            overflow: hidden;
        }


        .widget-content-left, .widget-content-right {
            flex: 0 0 60%;
            padding: 20px;
        }


        .widget-image-top, .widget-image-bottom {
            width: 100%;
            max-height: 300px;
            overflow: hidden;
        }


        .widget-content-top, .widget-content-bottom, .widget-content-full {
            width: 100%;
            padding: 20px;
        }


        .widget-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }


        /* Typography inside widget */
        #widget-preview h3 {
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
        }


        #widget-preview p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }


        #widget-preview ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }


        #widget-preview li {
            margin-bottom: 8px;
            position: relative;
            color: #555;
            line-height: 1.5;
        }


        /* Widget Code Display */
        #widget-code {
            margin-top: 20px;
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            max-height: 200px;
            overflow: auto;
            white-space: pre-wrap;
        }


        .copy-button {
            background-color: #2e86de;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 10px;
        }


        .copy-button:hover {
            background-color: #1c71c7;
        }


        /* Matrix Builder Styles */
        .matrix-editor {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background-color: white;
        }
        
        .matrix-headers {
            display: grid;
            grid-template-columns: 300px repeat(9, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .matrix-rows {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .matrix-row {
            display: grid;
            grid-template-columns: 300px repeat(9, 1fr);
            gap: 10px;
            align-items: center;
        }
        
        .cell-type-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* AI Content Generator Tab with MSP Focus */
        .msp-images-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .msp-image-item {
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 75%; /* This creates a consistent aspect ratio */
            overflow: hidden;
            border-radius: 4px;
        }

        .msp-image-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .msp-image-item.selected {
            border-color: #2980b9;
            box-shadow: 0 0 8px rgba(41, 128, 185, 0.6);
        }

        .msp-image-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.7);
            color: white;
            font-size: 12px;
            padding: 4px 5px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ai-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .ai-loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .msp-images-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .msp-images-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <h1>Salesbuildr Widget Template Tools</h1>
    
    <!-- Tab Navigation -->
    <div class="tabs">
        <button class="tab-button active" data-tab="extractor">Cover Page Creator</button>
        <button class="tab-button" data-tab="widget">Widget Creator</button>
        <button class="tab-button" data-tab="matrix">Matrix Builder</button>
        <button class="tab-button" data-tab="ai">AI Content Generator</button>
    </div>
    
    <!-- PDF Text Extractor Tab -->
    <div id="extractor" class="tab-content active">
        <p>Create Salesbuildr Cover Pages from PDF files.</p>
        
        <div class="container">
            <div id="dropzone" class="dropzone">
                <h2>Drag & Drop PDF Files Here</h2>
                <p>Or click to select files</p>
                <input type="file" id="file-input" style="display: none;" accept=".pdf" multiple>
            </div>
            
            <div class="options">
                <div class="option-group">
                    <label for="page-input">Page Numbers (comma-separated):</label>
                    <input type="text" id="page-input" placeholder="e.g., 1,2,5" value="1">
                    <small>Leave blank for all pages</small>
                </div>
                
                <div class="option-group">
                    <label for="dpi-input">DPI Resolution:</label>
                    <select id="dpi-input">
                        <option value="150">150 DPI (Fast)</option>
                        <option value="300" selected>300 DPI (Balanced)</option>
                        <option value="600">600 DPI (High Quality)</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="resize-input">Output Format:</label>
                    <select id="resize-input">
                        <option value="true" selected>Resize to A4</option>
                        <option value="false">Original Size</option>
                    </select>
                </div>
            </div>
            
            <div class="button-container">
                <button id="process-btn" disabled>Process PDFs</button>
                <button id="clear-btn">Clear Fields</button>
            </div>
            
            <div class="progress-container" id="progress-container">
                <p id="progress-text">Processing 0/0 files...</p>
                <progress id="progress-bar" value="0" max="100"></progress>
            </div>
            
            <div id="status" class="status" style="display: none;"></div>
            
            <div id="log-container" class="log-container">
                <p class="log-entry info">System ready. Upload PDF files to begin.</p>
            </div>
            
            <div id="preview-container" class="preview-container"></div>
        </div>
    </div>
    
    <!-- Widget Creator Tab -->
    <div id="widget" class="tab-content">
        <p>Create widgets using content from websites or build custom content. Paste HTML code into Salesbuildr.</p>
        
        <div class="container">
            <div class="widget-form">
                <div class="url-container">
                    <input type="url" id="website-url" class="url-input" placeholder="Enter website URL (e.g., https://example.com)">
                    <button id="fetch-content-btn">Fetch Content</button>
                </div>
                
                <div class="widget-options">
                    <div class="option-group">
                        <label for="image-position">Image Position:</label>
                        <select id="image-position">
                            <option value="left" selected>Left</option>
                            <option value="right">Right</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                        </select>
                    </div>
                    
                    <div class="option-group">
                        <label for="summary-length">Summary Length:</label>
                        <select id="summary-length">
                            <option value="1 Paragraph">1 Paragraph</option>
                            <option value="2 Paragraphs" selected>2 Paragraphs</option>
                            <option value="3 Paragraphs">3 Paragraphs</option>
                            <option value="4 Paragraphs">4 Paragraphs</option>
                        </select>
                    </div>
                    
                    <div class="option-group">
                        <label for="custom-image">Custom Image (optional):</label>
                        <input type="file" id="custom-image" accept="image/*">
                    </div>
                </div>
                
                <div class="text-content">
                    <label for="summary-text">Summary Text (edit as needed):</label>
                    <textarea id="summary-text" rows="6" placeholder="Your content summary will appear here. You can edit it as needed." style="width: 100%;"></textarea>
                </div>
                
                <div class="button-container">
                    <button id="generate-widget-btn">Generate Widget</button>
                    <button id="clear-all-btn">Clear All</button>
                </div>
                
                <div id="widget-status" class="status" style="display: none;"></div>
            </div>
            
            <div id="widget-preview-container">
                <h3>Widget Preview</h3>
                <div class="widget-preview" id="widget-preview"></div>
                
                <div class="code-container">
                    <div class="code-header">
                        <h3>HTML Code</h3>
                        <button id="copy-code-btn" class="copy-button">Copy Code</button>
                    </div>
                    <pre class="code-content" id="widget-code"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Matrix Builder Tab -->
    <div id="matrix" class="tab-content">
        <p>Create comparison tables and feature matrices for your products and services.</p>
        
        <div class="container">
            <div class="matrix-form">
                <h3>Table Settings</h3>
                <div class="options">
                    <div class="option-group">
                        <label for="matrix-rows">Number of Rows:</label>
                        <input type="number" id="matrix-rows" min="1" max="20" value="5">
                    </div>
                    
                    <div class="option-group">
                        <label for="matrix-columns">Number of Columns:</label>
                        <input type="number" id="matrix-columns" min="2" max="10" value="4">
                    </div>
                    
                    <div class="option-group">
                        <label for="header-bg-color">Header Background:</label>
                        <input type="color" id="header-bg-color" value="#96b83b">
                    </div>
                    
                    <div class="option-group">
                        <label for="header-text-color">Header Text:</label>
                        <input type="color" id="header-text-color" value="#ffffff">
                    </div>
                    
                    <div class="option-group">
                        <label for="row-bg-color-1">Row Background 1:</label>
                        <input type="color" id="row-bg-color-1" value="#f2f2f2">
                    </div>
                    
                    <div class="option-group">
                        <label for="row-bg-color-2">Row Background 2:</label>
                        <input type="color" id="row-bg-color-2" value="#ffffff">
                    </div>
                </div>
                
                <button id="update-matrix-btn" class="btn btn-primary">Update Matrix</button>
                
                <div id="matrix-editor" class="matrix-editor">
                    <div id="matrix-headers" class="matrix-headers">
                        <!-- Column headers will be generated here -->
                    </div>
                    
                    <div id="matrix-rows-container" class="matrix-rows">
                        <!-- Rows will be generated here -->
                    </div>
                </div>
                
                <div class="button-container">
                    <button id="generate-matrix-btn" class="btn btn-success">Generate Matrix</button>
                    <button id="clear-matrix-btn" class="btn btn-secondary">Clear All</button>
                </div>
            </div>
            
            <div id="matrix-preview-container" style="display: none;">
                <h3>Matrix Preview</h3>
                <div class="matrix-preview" id="matrix-preview"></div>
                
                <div class="code-container">
                    <div class="code-header">
                        <h3>HTML Code</h3>
                        <button id="copy-matrix-code-btn" class="btn btn-primary">Copy Code</button>
                    </div>
                    <div class="code-content" id="matrix-code"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- AI Content Generator Tab -->
    <div id="ai" class="tab-content">
        <p>Generate MSP marketing content using AI and convert it into widgets.</p>
        
        <div class="container">
            <div class="widget-form">
                <div class="options">
                    <div class="option-group">
                        <label for="content-topic">MSP Service or Topic:</label>
                        <input type="text" id="content-topic" placeholder="Enter topic (e.g., Managed Cloud Services)" style="width: 100%;">
                    </div>
                    
                    <div class="option-group">
                        <label for="content-tone">Tone:</label>
                        <select id="content-tone">
                            <option value="professional">Professional</option>
                            <option value="casual">Casual</option>
                            <option value="enthusiastic">Enthusiastic</option>
                            <option value="informative">Informative</option>
                        </select>
                    </div>
                    
                    <div class="option-group">
                        <label for="content-length">Content Length:</label>
                        <select id="content-length">
                            <option value="1 Paragraph">1 Paragraph</option>
                            <option value="2 Paragraphs" selected>2 Paragraphs</option>
                            <option value="3 Paragraphs">3 Paragraphs</option>
                        </select>
                    </div>
                </div>
                
                <div class="button-container">
                    <button id="generate-ai-btn">Generate AI Content</button>
                </div>
                
                <div class="progress-container" id="ai-progress-container" style="display: none;">
                    <p id="ai-progress-text">Generating content...</p>
                    <progress id="ai-progress-bar" value="50" max="100"></progress>
                </div>
                
                <div id="ai-status" class="status" style="display: none;"></div>
                
                <div class="image-section" style="margin-top: 20px;">
                    <label>Select Image for Content:</label>
                    <div class="options">
                        <div class="option-group">
                            <label for="image-source">Image Source:</label>
                            <select id="image-source">
                                <option value="stock">Built-in MSP Images</option>
                                <option value="upload">Upload Your Own Image</option>
                            </select>
                        </div>
                        
                        <div class="option-group" id="upload-image-section" style="display: none;">
                            <label for="ai-custom-image">Upload Image:</label>
                            <input type="file" id="ai-custom-image" accept="image/*">
                        </div>
                        
                        <div class="option-group" id="stock-image-section">
                            <label>Choose an MSP Image:</label>
                            <div class="msp-images-grid" id="msp-images-container">
                                <!-- MSP images will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-content" style="margin-top: 20px;">
                    <label for="ai-content-text">Generated Content (edit as needed):</label>
                    <textarea id="ai-content-text" rows="8" placeholder="Your AI-generated MSP marketing content will appear here. You can edit it as needed." style="width: 100%;" disabled></textarea>
                </div>
                
                <div class="button-container">
                    <button id="add-to-widget-btn" disabled>Add to Widget Creator</button>
                    <button id="clear-ai-btn">Clear All</button>
                </div>
            </div>
            
            <div id="ai-preview-container" style="display: none;">
                <h3>Content Preview</h3>
                <div class="widget-preview" id="ai-preview"></div>
            </div>
        </div>
    </div>
    
    <!-- Inline JavaScript -->
    <script>
        // Define MSP stock images
        window.mspStockImages = [
            { 
                id: 1, 
                name: "Cloud Services",
                base64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg=="
            },
            { 
                id: 2, 
                name: "Network Security",
                base64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg=="
            },
            { 
                id: 3, 
                name: "IT Support",
                base64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg=="
            },
            { 
                id: 4, 
                name: "Cybersecurity",
                base64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg=="
            },
            { 
                id: 5, 
                name: "Data Backup",
                base64: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg=="
            }
        ];
        
        // Set up PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        
        // Tab Switching
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to current button and corresponding content
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Initialize all tools - ONCE only
            initPdfExtractor();
            initWidgetCreator();
            initMatrixBuilder();
            initAIContentGenerator();
        });
        
        // -------------------------------
        // PDF IMAGE EXTRACTOR FUNCTIONALITY
        // -------------------------------
        function initPdfExtractor() {
            // DOM Elements
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const processBtn = document.getElementById('process-btn');
            const clearBtn = document.getElementById('clear-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const previewContainer = document.getElementById('preview-container');
            const statusElement = document.getElementById('status');
            const logContainer = document.getElementById('log-container');
            const pageInput = document.getElementById('page-input');
            const dpiInput = document.getElementById('dpi-input');
            const resizeInput = document.getElementById('resize-input');
            
            // Uploaded files storage
            let uploadedFiles = [];
            
            // Set up logging
            function logMessage(message, level = 'info') {
                const entry = document.createElement('p');
                entry.className = `log-entry ${level}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;
                
                // Also log to console
                switch(level) {
                    case 'error': console.error(message); break;
                    case 'warn': console.warn(message); break;
                    default: console.log(message);
                }
            }
            
            // Prevent defaults for drag and drop
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropzone.classList.add('dragover');
            }
            
            function unhighlight() {
                dropzone.classList.remove('dragover');
            }
            
            // Setup drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults);
                document.body.addEventListener(eventName, preventDefaults);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight);
            });
            
            // Handle file selection
            dropzone.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change handler
            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length === 0) return;
                
                // Filter for PDF files
                const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
                
                if (pdfFiles.length === 0) {
                    showStatus('No PDF files were selected.', 'error');
                    return;
                }
                
                // Store the files and enable the process button
                uploadedFiles = pdfFiles;
                logMessage(`Selected ${uploadedFiles.length} PDF files`);
                processBtn.disabled = false;
                
                // Clear previous results
                previewContainer.innerHTML = '';
                hideStatus();
            });
            
            // Drop handler
            dropzone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length === 0) return;
                
                // Filter for PDF files
                const pdfFiles = Array.from(files).filter(file => file.type === 'application/pdf');
                
                if (pdfFiles.length === 0) {
                    showStatus('No PDF files were selected.', 'error');
                    return;
                }
                
                // Store the files and enable the process button
                uploadedFiles = pdfFiles;
                logMessage(`Selected ${uploadedFiles.length} PDF files`);
                processBtn.disabled = false;
                
                // Clear previous results
                previewContainer.innerHTML = '';
                hideStatus();
            });
            
            // Process button click handler
            processBtn.addEventListener('click', async () => {
                if (uploadedFiles.length === 0) return;
                
                // Parse options
                const dpi = parseInt(dpiInput.value, 10);
                const resizeToA4 = resizeInput.value === 'true';
                
                // Parse page numbers
                let pageNumbers = [];
                if (pageInput.value.trim()) {
                    pageNumbers = pageInput.value.split(',')
                        .map(p => parseInt(p.trim(), 10))
                        .filter(p => !isNaN(p) && p > 0);
                }
                
                const options = {
                    dpi,
                    resizeToA4,
                    pageNumbers: pageNumbers.length > 0 ? pageNumbers : null
                };
                
                logMessage(`Processing ${uploadedFiles.length} files with options: ` + 
                          `DPI=${options.dpi}, Resize=${options.resizeToA4}, Pages=${options.pageNumbers || 'all'}`);
                
                // Disable the button during processing
                processBtn.disabled = true;
                
                // Show progress
                progressContainer.style.display = 'block';
                progressBar.max = uploadedFiles.length;
                progressBar.value = 0;
                progressText.textContent = `Processing 0/${uploadedFiles.length} files...`;
                
                // Clear previous results
                previewContainer.innerHTML = '';
                
                try {
                    let processedCount = 0;
                    
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        progressText.textContent = `Processing ${i+1}/${uploadedFiles.length}: ${file.name}`;
                        
                        try {
                            logMessage(`Processing ${file.name}`);
                            
                            // Read the file as array buffer
                            const fileData = await readFileAsArrayBuffer(file);
                            
                            // Process the PDF
                            const processedImages = await processPdf(fileData, options);
                            
                            if (processedImages.length > 0) {
                                logMessage(`Successfully processed ${file.name}, ${processedImages.length} pages extracted`);
                                processedCount++;
                                
                                // Display the results
                                processedImages.forEach(({ pageNum, imageData }) => {
                                    displayImage(file.name, pageNum, imageData);
                                });
                                
                                // Add a "Download All" button for multiple pages
                                if (processedImages.length > 1) {
                                    const downloadAllButton = document.createElement('button');
                                    downloadAllButton.textContent = `Download All Pages (${processedImages.length})`;
                                    downloadAllButton.className = 'download-all-button';
                                    
                                    downloadAllButton.addEventListener('click', () => {
                                        try {
                                            logMessage('Preparing to download all images as ZIP...');
                                            
                                            const zip = new JSZip();
                                            
                                            // Add each image to the zip
                                            for (const { pageNum, imageData } of processedImages) {
                                                const filename = `${file.name.replace('.pdf', '')}_page${pageNum}.png`;
                                                zip.file(filename, imageData);
                                            }
                                            
                                            // Generate the zip
                                            zip.generateAsync({ type: 'blob' }).then((zipContent) => {
                                                // Download the zip
                                                const a = document.createElement('a');
                                                a.href = URL.createObjectURL(zipContent);
                                                a.download = `${file.name.replace('.pdf', '')}_all_pages.zip`;
                                                document.body.appendChild(a);
                                                a.click();
                                                document.body.removeChild(a);
                                                
                                                logMessage('All pages downloaded as ZIP');
                                            }).catch(err => {
                                                logMessage(`Error creating ZIP: ${err.message}`, 'error');
                                            });
                                        } catch (err) {
                                            logMessage(`Error creating ZIP: ${err.message}`, 'error');
                                        }
                                    });
                                    
                                    previewContainer.insertAdjacentElement('beforebegin', downloadAllButton);
                                }
                            } else {
                                logMessage(`No images extracted from ${file.name}`, 'warn');
                            }
                        } catch (err) {
                            logMessage(`Error processing ${file.name}: ${err.message}`, 'error');
                        }
                        
                        // Update progress bar
                        progressBar.value = i + 1;
                    }
                    
                    progressText.textContent = `Processed ${processedCount}/${uploadedFiles.length} files`;
                    showStatus(`Successfully processed ${processedCount} out of ${uploadedFiles.length} files`, 'success');
                } catch (err) {
                    logMessage(`Error during processing: ${err.message}`, 'error');
                    showStatus('An error occurred during processing. Check the log for details.', 'error');
                } finally {
                    processBtn.disabled = false;
                }
            });
            
            // Clear fields button
            clearBtn.addEventListener('click', clearFields);
            
            // Function to clear all fields and reset the application
            function clearFields() {
                // Reset uploaded files
                uploadedFiles = [];
                
                // Reset input fields to defaults
                pageInput.value = '1';
                dpiInput.value = '300';
                resizeInput.value = 'true';
                
                // Clear results and status
                previewContainer.innerHTML = '';
                hideStatus();
                
                // Reset log container (keep only the initial message)
                logContainer.innerHTML = '<p class="log-entry info">System ready. Upload PDF files to begin.</p>';
                
                // Disable process button
                processBtn.disabled = true;
                
                // Hide progress container
                progressContainer.style.display = 'none';
                
                // Remove any download all buttons
                const downloadAllButtons = document.querySelectorAll('.download-all-button');
                downloadAllButtons.forEach(button => button.remove());
                
                // Clear the file input value
                fileInput.value = '';
                
                logMessage('All fields cleared. Ready for new files.');
            }
            
            // Display an image in the preview container
            function displayImage(fileName, pageNum, imageData) {
                // Create blob URL from the image data
                const blob = new Blob([imageData], { type: 'image/png' });
                const url = URL.createObjectURL(blob);
                
                // Create preview item
                const item = document.createElement('div');
                item.className = 'preview-item';
                
                // Preview header
                const header = document.createElement('div');
                header.className = 'preview-header';
                
                const title = document.createElement('h3');
                title.className = 'preview-title';
                title.textContent = `${fileName} - Page ${pageNum}`;
                header.appendChild(title);
                
                item.appendChild(header);
                
                // Preview image
                const img = document.createElement('img');
                img.className = 'preview-image';
                img.src = url;
                img.alt = `${fileName} - Page ${pageNum}`;
                item.appendChild(img);
                
                // Preview actions
                const actions = document.createElement('div');
                actions.className = 'preview-actions';
                
                // PNG Download button
                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'Download PNG';
                downloadBtn.addEventListener('click', () => {
                    // Create a download link
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName.replace('.pdf', '')}_page${pageNum}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                });
                
                actions.appendChild(downloadBtn);
                item.appendChild(actions);
                
                // Add to preview container
                previewContainer.appendChild(item);
            }
            
            // Helper function to read a File as ArrayBuffer
            function readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(reader.error);
                    reader.readAsArrayBuffer(file);
                });
            }
            
            // Helper functions for status display
            function showStatus(message, type) {
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                statusElement.style.display = 'block';
            }
            
            function hideStatus() {
                statusElement.style.display = 'none';
            }
            
            // Process PDF function - simplified mock version
            async function processPdf(pdfData, options = {}) {
                const results = [];
                let pdfDoc = null;
                
                try {
                    // Load the PDF document
                    pdfDoc = await pdfjsLib.getDocument({ data: pdfData }).promise;
                    logMessage(`PDF loaded with ${pdfDoc.numPages} pages`);
                    
                    // Determine which pages to process
                    const pagesToProcess = options.pageNumbers || Array.from(
                        { length: pdfDoc.numPages }, 
                        (_, i) => i + 1
                    );
                    
                    // Create a simple PNG data (for demo purposes)
                    // In a real implementation, you would extract images from PDF pages
                    const dummyPngData = new Uint8Array([137, 80, 78, 71, 13, 10, 26, 10]); 
                    
                    // For each page, add a result
                    for (const pageNum of pagesToProcess) {
                        if (pageNum < 1 || pageNum > pdfDoc.numPages) {
                            logMessage(`Page ${pageNum} out of range, skipping`, 'warn');
                            continue;
                        }
                        
                        results.push({
                            pageNum,
                            imageData: dummyPngData // In a real implementation, this would be actual PNG data
                        });
                        
                        logMessage(`Successfully processed page ${pageNum}`);
                    }
                    
                    return results;
                } catch (err) {
                    logMessage(`Error processing PDF: ${err.message}`, 'error');
                    throw err;
                }
            }
        }
        
        // -------------------------------
        // WIDGET CREATOR FUNCTIONALITY
        // -------------------------------
        function initWidgetCreator() {
            // DOM Elements
            const urlInput = document.getElementById('website-url');
            const fetchBtn = document.getElementById('fetch-content-btn');
            const imagePositionSelect = document.getElementById('image-position');
            const summaryLengthSelect = document.getElementById('summary-length');
            const customImageInput = document.getElementById('custom-image');
            const summaryTextarea = document.getElementById('summary-text');
            const generateWidgetBtn = document.getElementById('generate-widget-btn');
            const clearAllBtn = document.getElementById('clear-all-btn');
            const widgetStatus = document.getElementById('widget-status');
            const widgetPreviewContainer = document.getElementById('widget-preview-container');
            const widgetPreview = document.getElementById('widget-preview');
            const widgetCode = document.getElementById('widget-code');
            const copyCodeBtn = document.getElementById('copy-code-btn');
            
            // Initialize with widget-preview-container hidden
            if (widgetPreviewContainer) {
                widgetPreviewContainer.style.display = 'none';
            }
            
            // Event Listeners
            if (fetchBtn) fetchBtn.addEventListener('click', fetchWebsiteContent);
            if (customImageInput) customImageInput.addEventListener('change', handleCustomImage);
            if (generateWidgetBtn) generateWidgetBtn.addEventListener('click', generateWidget);
            if (clearAllBtn) clearAllBtn.addEventListener('click', clearWidgetForm);
            if (copyCodeBtn) copyCodeBtn.addEventListener('click', copyWidgetCode);
            
            // State variables
            let currentImageUrl = null;
            let customImageUrl = null;
            
            // Check for AI-generated content
            if (window.aiGeneratedImage) {
                customImageUrl = window.aiGeneratedImage;
                console.log('Found AI-generated image');
                window.aiGeneratedImage = null; // Clear after use
            }
            
            // Helper function for showing widget status messages
            function showWidgetStatus(message, type) {
                if (!widgetStatus) return;
                
                widgetStatus.textContent = message;
                widgetStatus.className = `status ${type}`;
                widgetStatus.style.display = 'block';
                setTimeout(() => {
                    widgetStatus.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }
            
            // Handle custom image upload
            function handleCustomImage(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showWidgetStatus('Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    customImageUrl = event.target.result;
                    showWidgetStatus('Custom image uploaded successfully.', 'success');
                };
                reader.readAsDataURL(file);
            }
            
            // Fetch website content - simplified mock version
            function fetchWebsiteContent() {
                const url = urlInput.value.trim();
                
                if (!url) {
                    showWidgetStatus('Please enter a valid URL.', 'error');
                    return;
                }
                
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    showWidgetStatus('URL must start with http:// or https://.', 'error');
                    return;
                }
                
                // Show loading status
                showWidgetStatus('Fetching website content...', 'info');
                fetchBtn.disabled = true;
                fetchBtn.textContent = 'Fetching...';
                summaryTextarea.value = 'Loading content...';
                
                // Simulate API delay
                setTimeout(() => {
                    // Simulate fetched content
                    const sampleContent = `This is sample content that would normally be fetched from the website at ${url}. In a real implementation, this would be extracted from the website's content.
                    
                    The content would typically include a summary of the main page, with paragraphs formatted appropriately for the widget.`;
                    
                    // Simulate fetched image
                    const sampleImageUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg==';
                    
                    // Update UI with the fetched content
                    summaryTextarea.value = sampleContent;
                    currentImageUrl = sampleImageUrl;
                    
                    // Store original content in data attributes
                    summaryTextarea.dataset.originalContent = sampleContent;
                    summaryTextarea.dataset.formattedContent = formatTextToHtml(sampleContent);
                    
                    // Update the preview with the fetched data
                    updateWidgetPreview(currentImageUrl, formatTextToHtml(sampleContent), imagePositionSelect.value);
                    
                    showWidgetStatus('Content fetched successfully!', 'success');
                    widgetPreviewContainer.style.display = 'block';
                    
                    // Reset the fetch button
                    fetchBtn.disabled = false;
                    fetchBtn.textContent = 'Fetch Content';
                }, 1500);
            }
            
            // Generate widget preview and code
            function generateWidget() {
                // Get settings
                const imagePosition = imagePositionSelect.value;
                const summaryText = summaryTextarea.value.trim();
                
                if (!summaryText) {
                    showWidgetStatus('Please fetch or enter content first.', 'error');
                    return;
                }
                
                // Use custom image if uploaded, otherwise use fetched image
                const imageUrl = customImageUrl || currentImageUrl || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAAnElEQVR42u3RAQ0AAAjDMO5fNCCDkC5z0HTVrisFCBABASIgQAQEiIAAAQJEQIAICBABASIgQIAAERAgAgJEQIAICBAgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAASIgQAQEiIAAERAgAgIECBABASIgQAQEiIAAAQJEQIAICBABERAgOy3q5JmSGbI0NAAAAABJRU5ErkJggg==';
                
                // Get the formatted content (either from data attribute or format the current text)
                const formattedContent = summaryTextarea.dataset.formattedContent || formatTextToHtml(summaryText);
                
                // Update the widget preview
                updateWidgetPreview(imageUrl, formattedContent, imagePosition);
                
                // Generate the widget code for embedding
                const widgetCode = generateWidgetCode(imageUrl, formattedContent, imagePosition);
                
                // Show the widget code
                if (widgetCode) {
                    document.getElementById('widget-code').textContent = widgetCode;
                    widgetPreviewContainer.style.display = 'block';
                }
                
                showWidgetStatus('Widget generated successfully!', 'success');
            }
            
            // Update the widget preview with the given content and image position
            function updateWidgetPreview(imageUrl, content, position = 'left') {
                if (!widgetPreview) return;
                
                // Always create a 2-column x 1-row table layout with centered image
                let widgetHtml = `
                    <table style="width:100%; border-collapse:collapse; border:none;">
                        <tr>
                `;
                
                if (position === 'left') {
                    widgetHtml += `
                            <td style="width:30%; vertical-align:middle; text-align:center; padding:10px;">
                                <img src="${imageUrl}" alt="Content Image" style="max-width:100%; height:auto; margin:0 auto; display:block;">
                            </td>
                            <td style="width:70%; vertical-align:top; padding:10px;">
                                ${content}
                            </td>
                    `;
                } else if (position === 'right') {
                    widgetHtml += `
                            <td style="width:70%; vertical-align:top; padding:10px;">
                                ${content}
                            </td>
                            <td style="width:30%; vertical-align:middle; text-align:center; padding:10px;">
                                <img src="${imageUrl}" alt="Content Image" style="max-width:100%; height:auto; margin:0 auto; display:block;">
                            </td>
                    `;
                } else if (position === 'top' || position === 'bottom') {
                    // For top/bottom positions, we'll still use a 2-column table but make the image span both columns
                    const imageHtml = `
                        <td colspan="2" style="text-align:center; padding:10px;">
                            <img src="${imageUrl}" alt="Content Image" style="max-width:50%; height:auto; margin:0 auto; display:block;">
                        </td>
                    `;
                    
                    const contentHtml = `
                        <td colspan="2" style="padding:10px;">
                            ${content}
                        </td>
                    `;
                    
                    // Close the first row and add a second row
                    widgetHtml += position === 'top' 
                        ? `${imageHtml}</tr><tr>${contentHtml}`
                        : `${contentHtml}</tr><tr>${imageHtml}`;
                } else {
                    // No image - content takes full width
                    widgetHtml += `
                            <td colspan="2" style="padding:10px;">
                                ${content}
                            </td>
                    `;
                }
                
                widgetHtml += `
                        </tr>
                    </table>
                `;
                
                // Update the preview area
                widgetPreview.innerHTML = widgetHtml;
            }
            
            // Format plain text to HTML (detect paragraphs and lists)
            function formatTextToHtml(text) {
                if (!text) return '';
                
                // Split by new lines to identify paragraphs and lists
                const lines = text.split('\n');
                let html = '';
                let inList = false;
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) {
                        // Empty line - close any open list
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        return;
                    }
                    
                    // Check if it's a list item (bullet point)
                    if (line.startsWith('') || line.startsWith('-') || line.startsWith('*')) {
                        if (!inList) {
                            html += '<ul>';
                            inList = true;
                        }
                        html += `<li>${line.substring(1).trim()}</li>`;
                    } 
                    // Check if it's a heading
                    else if (line.startsWith('Key Features:') || line.startsWith('#')) {
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        html += `<h3>${line.replace('#', '').trim()}</h3>`;
                    }
                    // Regular paragraph
                    else {
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        html += `<p>${line}</p>`;
                    }
                });
                
                // Close any open list
                if (inList) {
                    html += '</ul>';
                }
                
                return html;
            }
            
            // Generate embeddable widget code with base64 image
            function generateWidgetCode(imageUrl, content, position) {
                // FIXED: Only generate the table structure, not any page elements
                // Create a simple 2-column x 1-row table with centered image
                let widgetHtml = `<table style="width:100%; border-collapse:collapse; border:none;">\n  <tr>\n`;
                
                if (position === 'left') {
                    widgetHtml += `    <td style="width:30%; vertical-align:middle; text-align:center; padding:10px;">\n      <img src="${imageUrl}" alt="Content Image" style="max-width:100%; height:auto; margin:0 auto; display:block;">\n    </td>\n    <td style="width:70%; vertical-align:top; padding:10px;">\n      ${content}\n    </td>\n`;
                } else if (position === 'right') {
                    widgetHtml += `    <td style="width:70%; vertical-align:top; padding:10px;">\n      ${content}\n    </td>\n    <td style="width:30%; vertical-align:middle; text-align:center; padding:10px;">\n      <img src="${imageUrl}" alt="Content Image" style="max-width:100%; height:auto; margin:0 auto; display:block;">\n    </td>\n`;
                } else if (position === 'top') {
                    widgetHtml += `    <td colspan="2" style="text-align:center; padding:10px;">\n      <img src="${imageUrl}" alt="Content Image" style="max-width:50%; height:auto; margin:0 auto; display:block;">\n    </td>\n  </tr>\n  <tr>\n    <td colspan="2" style="padding:10px;">\n      ${content}\n    </td>\n`;
                } else if (position === 'bottom') {
                    widgetHtml += `    <td colspan="2" style="padding:10px;">\n      ${content}\n    </td>\n  </tr>\n  <tr>\n    <td colspan="2" style="text-align:center; padding:10px;">\n      <img src="${imageUrl}" alt="Content Image" style="max-width:50%; height:auto; margin:0 auto; display:block;">\n    </td>\n`;
                } else {
                    // No image - content takes full width
                    widgetHtml += `    <td colspan="2" style="padding:10px;">\n      ${content}\n    </td>\n`;
                }
                
                widgetHtml += `  </tr>\n</table>`;
                
                return widgetHtml;
            }
            
            // Copy widget code to clipboard
            function copyWidgetCode() {
                const codeText = document.getElementById('widget-code').textContent;
                
                navigator.clipboard.writeText(codeText)
                    .then(() => {
                        copyCodeBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyCodeBtn.textContent = 'Copy Code';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        
                        // Fallback copy method
                        const textarea = document.createElement('textarea');
                        textarea.value = codeText;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        
                        copyCodeBtn.textContent = 'Copied!';
                        setTimeout(() => {
                            copyCodeBtn.textContent = 'Copy Code';
                        }, 2000);
                    });
            }
            
            // Clear widget form
            function clearWidgetForm() {
                if (urlInput) urlInput.value = '';
                if (summaryTextarea) summaryTextarea.value = '';
                if (customImageInput) customImageInput.value = '';
                
                // Reset data attributes
                if (summaryTextarea) {
                    delete summaryTextarea.dataset.originalContent;
                    delete summaryTextarea.dataset.formattedContent;
                    delete summaryTextarea.dataset.imageUrl;
                }
                
                // Reset state variables
                currentImageUrl = null;
                customImageUrl = null;
                
                // Hide preview container
                if (widgetPreviewContainer) {
                    widgetPreviewContainer.style.display = 'none';
                }
                
                // Clear preview
                if (widgetPreview) {
                    widgetPreview.innerHTML = '';
                }
                
                // Clear code
                if (widgetCode) {
                    widgetCode.textContent = '';
                }
                
                showWidgetStatus('Form cleared.', 'info');
            }
        }
        
        // -------------------------------
        // MATRIX BUILDER FUNCTIONALITY
        // -------------------------------
        function initMatrixBuilder() {
            console.log('Initializing Matrix Builder...');
            
            // Simple stub implementation for the matrix builder
            const updateMatrixBtn = document.getElementById('update-matrix-btn');
            if (updateMatrixBtn) {
                updateMatrixBtn.addEventListener('click', function() {
                    console.log('Matrix updated');
                });
            }
            
            const generateMatrixBtn = document.getElementById('generate-matrix-btn');
            if (generateMatrixBtn) {
                generateMatrixBtn.addEventListener('click', function() {
                    console.log('Matrix generated');
                    // Show a preview
                    const previewContainer = document.getElementById('matrix-preview-container');
                    if (previewContainer) {
                        previewContainer.style.display = 'block';
                    }
                    
                    // Add sample matrix HTML to preview
                    const preview = document.getElementById('matrix-preview');
                    if (preview) {
                        preview.innerHTML = `
                            <table style="width:100%; border-collapse:collapse;">
                                <tr>
                                    <th style="padding:12px; text-align:left; background-color:#96b83b; color:#ffffff;">Feature/Service</th>
                                    <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Basic</th>
                                    <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Standard</th>
                                    <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Premium</th>
                                </tr>
                                <tr>
                                    <td style="padding:12px; text-align:left; background-color:#f2f2f2;">24/7 Monitoring</td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                </tr>
                                <tr>
                                    <td style="padding:12px; text-align:left; background-color:#ffffff;">Help Desk Support</td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                </tr>
                                <tr>
                                    <td style="padding:12px; text-align:left; background-color:#f2f2f2;">Onsite Support</td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                </tr>
                                <tr>
                                    <td style="padding:12px; text-align:left; background-color:#ffffff;">Strategic IT Planning</td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"></td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"></td>
                                    <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                </tr>
                                <tr>
                                    <td style="padding:12px; text-align:left; background-color:#f2f2f2;">Virtual CIO</td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
                                    <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
                                </tr>
                            </table>
                        `;
                    }
                    
                    // Add code to the code display
                    const codeDisplay = document.getElementById('matrix-code');
                    if (codeDisplay) {
                        // FIXED: Only include the table HTML, not page elements
                        codeDisplay.innerText = `<table style="width:100%; border-collapse:collapse;">
    <tr>
        <th style="padding:12px; text-align:left; background-color:#96b83b; color:#ffffff;">Feature/Service</th>
        <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Basic</th>
        <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Standard</th>
        <th style="padding:12px; text-align:center; background-color:#96b83b; color:#ffffff;">Premium</th>
    </tr>
    <tr>
        <td style="padding:12px; text-align:left; background-color:#f2f2f2;">24/7 Monitoring</td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
    </tr>
    <tr>
        <td style="padding:12px; text-align:left; background-color:#ffffff;">Help Desk Support</td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
    </tr>
    <tr>
        <td style="padding:12px; text-align:left; background-color:#f2f2f2;">Onsite Support</td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
    </tr>
    <tr>
        <td style="padding:12px; text-align:left; background-color:#ffffff;">Strategic IT Planning</td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"></td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"></td>
        <td style="padding:12px; text-align:center; background-color:#ffffff;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
    </tr>
    <tr>
        <td style="padding:12px; text-align:left; background-color:#f2f2f2;">Virtual CIO</td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"></td>
        <td style="padding:12px; text-align:center; background-color:#f2f2f2;"><div style="display:inline-block; width:24px; height:24px; background-color:#8bc34a; border-radius:50%; text-align:center; line-height:24px; color:white;"></div></td>
    </tr>
</table>`;
                    }
                });
            }
            
            const clearMatrixBtn = document.getElementById('clear-matrix-btn');
            if (clearMatrixBtn) {
                clearMatrixBtn.addEventListener('click', function() {
                    // Hide the preview
                    const previewContainer = document.getElementById('matrix-preview-container');
                    if (previewContainer) {
                        previewContainer.style.display = 'none';
                    }
                    console.log('Matrix cleared');
                });
            }
            
            const copyMatrixCodeBtn = document.getElementById('copy-matrix-code-btn');
            if (copyMatrixCodeBtn) {
                copyMatrixCodeBtn.addEventListener('click', function() {
                    const codeDisplay = document.getElementById('matrix-code');
                    if (codeDisplay) {
                        // Copy to clipboard
                        navigator.clipboard.writeText(codeDisplay.innerText)
                            .then(() => {
                                copyMatrixCodeBtn.textContent = 'Copied!';
                                setTimeout(() => {
                                    copyMatrixCodeBtn.textContent = 'Copy Code';
                                }, 2000);
                            })
                            .catch(err => {
                                console.error('Failed to copy: ', err);
                                
                                // Fallback
                                const textarea = document.createElement('textarea');
                                textarea.value = codeDisplay.innerText;
                                document.body.appendChild(textarea);
                                textarea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textarea);
                                
                                copyMatrixCodeBtn.textContent = 'Copied!';
                                setTimeout(() => {
                                    copyMatrixCodeBtn.textContent = 'Copy Code';
                                }, 2000);
                            });
                    }
                });
            }
        }
        
        // -------------------------------
        // AI CONTENT GENERATOR FUNCTIONALITY
        // -------------------------------
        function initAIContentGenerator() {
            console.log('Initializing AI Content Generator for MSPs...');
            
            // DOM Elements
            const contentTopic = document.getElementById('content-topic');
            const contentTone = document.getElementById('content-tone');
            const contentLength = document.getElementById('content-length');
            const generateAIBtn = document.getElementById('generate-ai-btn');
            const aiCustomImage = document.getElementById('ai-custom-image');
            const aiContentText = document.getElementById('ai-content-text');
            const addToWidgetBtn = document.getElementById('add-to-widget-btn');
            const clearAIBtn = document.getElementById('clear-ai-btn');
            const aiStatus = document.getElementById('ai-status');
            const aiPreviewContainer = document.getElementById('ai-preview-container');
            const aiPreview = document.getElementById('ai-preview');
            const aiProgressContainer = document.getElementById('ai-progress-container');
            const aiProgressBar = document.getElementById('ai-progress-bar');
            const aiProgressText = document.getElementById('ai-progress-text');
            const imageSource = document.getElementById('image-source');
            const uploadImageSection = document.getElementById('upload-image-section');
            const stockImageSection = document.getElementById('stock-image-section');
            const mspImagesContainer = document.getElementById('msp-images-container');
            
            // State variables
            let generatedContent = null;
            let formattedContent = null;
            let selectedImageUrl = null;
            let customImageBase64 = null;
            
            // Event Listeners
            if (generateAIBtn) generateAIBtn.addEventListener('click', generateAIContent);
            if (aiCustomImage) aiCustomImage.addEventListener('change', handleCustomImage);
            if (addToWidgetBtn) addToWidgetBtn.addEventListener('click', addToWidget);
            if (clearAIBtn) clearAIBtn.addEventListener('click', clearAIContent);
            if (imageSource) imageSource.addEventListener('change', toggleImageSource);
            
            // Initialize MSP images
            loadMSPImages();
            
            // Toggle between image sources
            function toggleImageSource() {
                const source = imageSource.value;
                
                if (source === 'upload') {
                    uploadImageSection.style.display = 'block';
                    stockImageSection.style.display = 'none';
                } else {
                    uploadImageSection.style.display = 'none';
                    stockImageSection.style.display = 'block';
                }
            }
            
            // Load MSP images into the grid
            function loadMSPImages() {
                if (!mspImagesContainer) return;
                mspImagesContainer.innerHTML = '';
                
                // Check if mspStockImages exists
                if (typeof mspStockImages === 'undefined' || !mspStockImages.length) {
                    mspImagesContainer.innerHTML = '<p>No MSP images found</p>';
                    console.error('mspStockImages array is not defined or empty');
                    return;
                }
                
                mspStockImages.forEach(image => {
                    const imageItem = document.createElement('div');
                    imageItem.className = 'msp-image-item';
                    imageItem.dataset.id = image.id;
                    
                    const img = document.createElement('img');
                    img.src = image.base64;
                    img.alt = `MSP image - ${image.name}`;
                    
                    const label = document.createElement('div');
                    label.className = 'msp-image-label';
                    label.textContent = image.name;
                    
                    imageItem.appendChild(img);
                    imageItem.appendChild(label);
                    mspImagesContainer.appendChild(imageItem);
                    
                    // Add click event
                    imageItem.addEventListener('click', () => selectMSPImage(image.id));
                });
            }
            
            // Select MSP image
            function selectMSPImage(id) {
                // Remove selected class from all images
                document.querySelectorAll('.msp-image-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selected class to clicked image
                const selectedItem = document.querySelector(`.msp-image-item[data-id="${id}"]`);
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                    
                    // Get the image data
                    const selectedImage = mspStockImages.find(img => img.id == id);
                    if (selectedImage) {
                        selectedImageUrl = selectedImage.base64;
                        updatePreview();
                    }
                }
            }
            
            // Handle custom image upload
            function handleCustomImage(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    showAIStatus('Please select a valid image file.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    customImageBase64 = event.target.result;
                    selectedImageUrl = customImageBase64;
                    updatePreview();
                    showAIStatus('Image uploaded successfully.', 'success');
                };
                reader.readAsDataURL(file);
            }
            
            // Generate AI content for MSP (local version)
            function generateAIContent() {
                const topic = contentTopic.value.trim();
                
                if (!topic) {
                    showAIStatus('Please enter an MSP service or topic for content generation.', 'error');
                    return;
                }
                
                // Show loading
                aiProgressContainer.style.display = 'block';
                generateAIBtn.disabled = true;
                aiContentText.disabled = true;
                aiContentText.value = 'Generating MSP content...';
                
                // Simulate API delay
                setTimeout(() => {
                    // Create sample content based on topic
                    const sampleContent = generateSampleContent(topic, contentTone.value, contentLength.value);
                    
                    // Update the textarea with generated content
                    generatedContent = sampleContent;
                    formattedContent = formatTextToHtml(sampleContent);
                    
                    aiContentText.value = sampleContent;
                    aiContentText.disabled = false;
                    addToWidgetBtn.disabled = false;
                    
                    // If no image is selected, select the first one that matches the topic
                    if (!selectedImageUrl) {
                        suggestImageBasedOnTopic(topic);
                    }
                    
                    // Update preview
                    updatePreview();
                    
                    // Hide loading
                    aiProgressContainer.style.display = 'none';
                    generateAIBtn.disabled = false;
                    
                    showAIStatus('MSP content generated successfully!', 'success');
                }, 1500);
            }
            
            // Generate sample content until the serverless function is ready
            function generateSampleContent(topic, tone, length) {
                const toneAdjective = {
                    'professional': 'professional',
                    'casual': 'approachable',
                    'enthusiastic': 'exciting',
                    'informative': 'detailed'
                }[tone] || 'professional';
                
                const paragraphCount = {
                    '1 Paragraph': 1,
                    '2 Paragraphs': 2,
                    '3 Paragraphs': 3
                }[length] || 2;
                
                let content = '';
                
                // First paragraph - introduction
                content += `Our ${toneAdjective} ${topic} solutions provide businesses with reliable, secure technology infrastructure without the overhead of managing it themselves. As a trusted Managed Service Provider, we handle all aspects of your ${topic.toLowerCase()} needs, allowing you to focus on your core business while we ensure your technology operates at peak efficiency.\n\n`;
                
                if (paragraphCount >= 2) {
                    // Second paragraph - benefits
                    content += `By partnering with us for ${topic}, you gain access to enterprise-grade technology, 24/7 monitoring and support, and predictable monthly costs. Our team of certified professionals proactively manages your IT environment to prevent issues before they impact your business, resulting in reduced downtime and improved productivity.\n\n`;
                }
                
                if (paragraphCount >= 3) {
                    // Third paragraph - call to action
                    content += `Contact us today to learn how our ${topic} services can transform your business operations. We'll develop a customized solution that addresses your specific challenges and helps you achieve your business goals through optimized technology management.\n\n`;
                }
                
                // Add bullet points of benefits
                content += `Key Benefits:\n`;
                content += ` Reduced IT costs and predictable monthly expenses\n`;
                content += ` Improved security and compliance management\n`;
                content += ` 24/7 monitoring and rapid issue resolution\n`;
                content += ` Access to expert IT professionals and latest technologies`;
                
                return content;
            }
            
            // Suggest image based on topic
            function suggestImageBasedOnTopic(topic) {
                if (!topic) return;
                
                // Convert topic to lowercase for easier matching
                const lowerTopic = topic.toLowerCase();
                
                // Define some keyword matches for each image
                const matches = [
                    { id: 1, keywords: ['cloud', 'hosting', 'server', 'virtualization', 'azure', 'aws'] },
                    { id: 2, keywords: ['security', 'firewall', 'protect', 'threat', 'defense', 'cyber'] },
                    { id: 3, keywords: ['support', 'service', 'help desk', 'assistance', 'technical'] },
                    { id: 4, keywords: ['cybersecurity', 'ransomware', 'malware', 'hacker', 'phishing'] },
                    { id: 5, keywords: ['backup', 'recovery', 'disaster', 'storage', 'data'] }
                ];
                
                // Find the best match
                let bestMatch = null;
                let highestScore = 0;
                
                matches.forEach(match => {
                    let score = 0;
                    match.keywords.forEach(keyword => {
                        if (lowerTopic.includes(keyword)) {
                            score += 1;
                        }
                    });
                    
                    if (score > highestScore) {
                        highestScore = score;
                        bestMatch = match.id;
                    }
                });
                
                // If we found a match, select that image
                if (bestMatch && highestScore > 0) {
                    selectMSPImage(bestMatch);
                } else {
                    // Default to the first image if no match
                    selectMSPImage(1);
                }
            }
            
            // Update preview
            function updatePreview() {
                if (!formattedContent && !aiContentText.value) {
                    aiPreviewContainer.style.display = 'none';
                    return;
                }
                
                // Get the content from the textarea in case the user edited it
                const content = aiContentText.value;
                const formatted = formattedContent || formatTextToHtml(content);
                const imageUrl = selectedImageUrl || (mspStockImages && mspStockImages.length > 0 ? mspStockImages[0].base64 : null);
                
                if (!imageUrl) {
                    showAIStatus('No image selected or available', 'error');
                    return;
                }
                
                // Create a table with the content and image - ONLY table structure, not page elements
                let previewHtml = `
                    <table style="width:100%; border-collapse:collapse; border:none;">
                        <tr>
                            <td style="width:70%; vertical-align:top; padding:10px;">
                                ${formatted}
                            </td>
                            <td style="width:30%; vertical-align:middle; text-align:center; padding:10px;">
                                <img src="${imageUrl}" alt="MSP Content Image" style="max-width:100%; height:auto; margin:0 auto; display:block;">
                            </td>
                        </tr>
                    </table>
                `;
                
                // Update the preview
                aiPreview.innerHTML = previewHtml;
                aiPreviewContainer.style.display = 'block';
            }
            
            // Add the generated content to the widget creator
            function addToWidget() {
                if (!aiContentText.value.trim()) {
                    showAIStatus('Please generate content first.', 'error');
                    return;
                }
                
                try {
                    // Get the content from the textarea in case the user edited it
                    const content = aiContentText.value;
                    const formatted = formattedContent || formatTextToHtml(content);
                    const imageUrl = selectedImageUrl || (mspStockImages && mspStockImages.length > 0 ? mspStockImages[0].base64 : null);
                    
                    if (!imageUrl) {
                        showAIStatus('No image selected or available', 'error');
                        return;
                    }
                    
                    // Switch to widget tab
                    const widgetTabBtn = document.querySelector('.tab-button[data-tab="widget"]');
                    if (widgetTabBtn) {
                        widgetTabBtn.click();
                    }
                    
                    // Fill the widget creator form with the AI-generated content
                    // Get the widget creator elements
                    const summaryTextarea = document.getElementById('summary-text');
                    
                    if (summaryTextarea) {
                        // Update the summary text
                        summaryTextarea.value = content;
                        
                        // Store the formatted content in data attributes
                        summaryTextarea.dataset.originalContent = content;
                        summaryTextarea.dataset.formattedContent = formatted;
                        
                        // Handle the image
                        window.aiGeneratedImage = imageUrl;
                        
                        showAIStatus('Content added to Widget Creator successfully.', 'success');
                    } else {
                        showAIStatus('Widget Creator not found. Please check the integration.', 'error');
                    }
                } catch (error) {
                    console.error('Error adding to widget:', error);
                    showAIStatus('Error adding to Widget Creator.', 'error');
                }
            }
            
            // Clear all AI content
            function clearAIContent() {
                contentTopic.value = '';
                contentTone.value = 'professional';
                contentLength.value = '2 Paragraphs';
                if (aiCustomImage) aiCustomImage.value = '';
                aiContentText.value = '';
                aiContentText.disabled = true;
                addToWidgetBtn.disabled = true;
                
                // Reset state variables
                generatedContent = null;
                formattedContent = null;
                selectedImageUrl = null;
                customImageBase64 = null;
                
                // Reset selected MSP image
                document.querySelectorAll('.msp-image-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Hide preview
                aiPreviewContainer.style.display = 'none';
                
                // Reset image source
                imageSource.value = 'stock';
                toggleImageSource();
                
                showAIStatus('All content cleared.', 'info');
            }
            
            // Helper function for showing status messages
            function showAIStatus(message, type) {
                if (!aiStatus) return;
                
                aiStatus.textContent = message;
                aiStatus.className = `status ${type}`;
                aiStatus.style.display = 'block';
                
                // Hide after 5 seconds
                setTimeout(() => {
                    aiStatus.style.display = 'none';
                }, 5000);
            }
            
            // Format plain text to HTML (similar to the widget creator's function)
            function formatTextToHtml(text) {
                if (!text) return '';
                
                // Split by new lines to identify paragraphs and lists
                const lines = text.split('\n');
                let html = '';
                let inList = false;
                
                lines.forEach(line => {
                    line = line.trim();
                    if (!line) {
                        // Empty line - close any open list
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        return;
                    }
                    
                    // Check if it's a list item (bullet point)
                    if (line.startsWith('') || line.startsWith('-') || line.startsWith('*')) {
                        if (!inList) {
                            html += '<ul>';
                            inList = true;
                        }
                        html += `<li>${line.substring(1).trim()}</li>`;
                    } 
                    // Check if it's a heading
                    else if (line.startsWith('Key') || line.startsWith('#')) {
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        html += `<h3>${line.replace('#', '').trim()}</h3>`;
                    }
                    // Regular paragraph
                    else {
                        if (inList) {
                            html += '</ul>';
                            inList = false;
                        }
                        html += `<p>${line}</p>`;
                    }
                });
                
                // Close any open list
                if (inList) {
                    html += '</ul>';
                }
                
                return html;
            }
        }
    </script>
</body>
</html>


