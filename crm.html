<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Salesbuildr Customer Follow-up Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #111827;
      color: #f9fafb;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
    }
    header .sub {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    header .actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }
    button, input[type="submit"] {
      border: none;
      border-radius: 999px;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      background: #2563eb;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    button.secondary {
      background: #374151;
    }
    button.danger {
      background: #b91c1c;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    main {
      display: grid;
      grid-template-columns: minmax(280px, 360px) minmax(0, 1fr);
      gap: 1rem;
      padding: 1rem;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1rem;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.06);
    }
    .card h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card h3 {
      margin: 1rem 0 0.5rem;
      font-size: 0.9rem;
    }
    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 0.1rem 0.6rem;
      font-size: 0.7rem;
      background: #e5e7eb;
      color: #374151;
    }
    .pill.overdue {
      background: #fee2e2;
      color: #b91c1c;
    }
    .pill.today {
      background: #d1fae5;
      color: #047857;
    }
    .pill.week {
      background: #dbebff;
      color: #1d4ed8;
    }
    .pill.primary {
      background: #dbeafe;
      color: #1d4ed8;
    }
    .customer-list {
      margin: 0;
      padding: 0;
      list-style: none;
      max-height: 60vh;
      overflow-y: auto;
    }
    .customer-list li {
      border-radius: 0.5rem;
      padding: 0.6rem 0.7rem;
      margin-bottom: 0.4rem;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background 0.1s, border-color 0.1s;
    }
    .customer-list li:hover {
      background: #f3f4ff;
    }
    .customer-list li.active {
      border-color: #2563eb;
      background: #e5edff;
    }
    .customer-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }
    .customer-meta {
      font-size: 0.75rem;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .customer-meta span {
      white-space: nowrap;
    }
    .section-inline {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .section-inline small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    form label {
      display: block;
      font-size: 0.8rem;
      margin: 0.4rem 0 0.1rem;
      color: #4b5563;
    }
    input[type="text"],
    input[type="email"],
    input[type="date"],
    textarea,
    select {
      width: 100%;
      padding: 0.4rem 0.5rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      font-family: inherit;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.75rem;
    }
    @media (max-width: 600px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }
    .muted {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .contact-history {
      margin-top: 0.5rem;
      max-height: 220px;
      overflow-y: auto;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      background: #f9fafb;
    }
    .history-item {
      padding: 0.45rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      font-size: 0.8rem;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      gap: 0.25rem;
    }
    .history-header strong {
      font-size: 0.8rem;
    }
    .history-body {
      margin-top: 0.2rem;
      white-space: pre-wrap;
    }
    .history-meta {
      margin-top: 0.2rem;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .history-link a {
      word-break: break-all;
      font-size: 0.75rem;
    }
    .mt-1 {
      margin-top: 0.5rem;
    }
    .mt-2 {
      margin-top: 0.75rem;
    }
    .tagline {
      font-size: 0.8rem;
      color: #4b5563;
      margin: 0.25rem 0 0.5rem;
    }
    .empty-state {
      font-size: 0.85rem;
      color: #6b7280;
      text-align: center;
      padding: 1.5rem 0.5rem;
    }
    .badge-count {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .search-row {
      margin-bottom: 0.75rem;
    }
    .search-row input {
      width: 100%;
      padding: 0.35rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 0.8rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.75rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab-button {
      padding: 0.35rem 0.75rem;
      font-size: 0.8rem;
      border-radius: 999px 999px 0 0;
      border: none;
      background: transparent;
      color: #4b5563;
      cursor: pointer;
    }
    .tab-button.active {
      background: #eef2ff;
      color: #1d4ed8;
      font-weight: 500;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* Contacts list */
    .contacts-list {
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      padding: 0.5rem;
      background: #f9fafb;
      max-height: 180px;
      overflow-y: auto;
      font-size: 0.8rem;
    }
    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding: 0.3rem 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .contact-item:last-child {
      border-bottom: none;
    }
    .contact-main {
      flex: 1;
    }
    .contact-name {
      font-weight: 600;
    }
    .contact-email {
      color: #6b7280;
      font-size: 0.75rem;
    }
    .contact-actions {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
    }
    .contact-actions label {
      margin: 0;
      font-size: 0.75rem;
    }
    .contact-actions button {
      padding: 0.15rem 0.5rem;
      font-size: 0.7rem;
      border-radius: 999px;
      background: #f97373;
    }

    /* Calendar */
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .calendar-title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .calendar-nav button {
      padding: 0.2rem 0.6rem;
      font-size: 0.8rem;
      background: #e5e7eb;
      color: #374151;
      border-radius: 999px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 0.75rem;
    }
    .calendar-cell {
      border-radius: 0.4rem;
      padding: 0.25rem;
      min-height: 65px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }
    .calendar-cell-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #6b7280;
      margin-bottom: 0.1rem;
    }
    .calendar-cell.today {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb;
    }
    .calendar-day-name {
      text-align: center;
      font-weight: 600;
      color: #6b7280;
      padding: 0.25rem 0;
    }
    .calendar-entry {
      background: #e5edff;
      border-radius: 999px;
      padding: 0.05rem 0.3rem;
      margin-bottom: 0.05rem;
      font-size: 0.7rem;
      cursor: pointer;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .calendar-empty-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Salesbuildr Follow-up Tracker</h1>
      <div class="sub">Simple CRM to know who to call each week.</div>
    </div>
    <div class="actions">
      <button id="export-btn" class="secondary">â¬‡ Export backup</button>
      <label for="import-input" style="font-size:0.8rem; cursor:pointer;">
        <span style="padding:0.25rem 0.7rem;border-radius:999px;border:1px solid #4b5563;">â¬† Import</span>
        <input id="import-input" type="file" accept="application/json" style="display:none;">
      </label>
    </div>
  </header>

  <main>
    <!-- Left column: Dashboard + list -->
    <section class="card" id="dashboard-card">
      <h2>
        <span>Dashboard</span>
        <span class="badge-count" id="customer-count"></span>
      </h2>
      <p class="tagline">
        Shows customers whose <strong>next monthly check-in</strong> is due.
      </p>

      <div class="search-row">
        <input
          type="text"
          id="search-input"
          placeholder="Search for company..."
        />
      </div>

      <div>
        <h3>Due now / overdue</h3>
        <ul class="customer-list" id="list-overdue"></ul>
        <div id="empty-overdue" class="muted">No one is overdue. ðŸŽ‰</div>
      </div>

      <div class="mt-2">
        <h3>This week</h3>
        <ul class="customer-list" id="list-week"></ul>
        <div id="empty-week" class="muted">No one due this week yet.</div>
      </div>

      <div class="mt-2">
        <h3>Later</h3>
        <ul class="customer-list" id="list-later"></ul>
        <div id="empty-later" class="muted">Everyone is already covered.</div>
      </div>

      <div id="search-empty" class="muted" style="display:none; margin-top:0.5rem;">
        No customers match that search.
      </div>
    </section>

    <!-- Right column: Tabs (Details / Add / Calendar) -->
    <section class="card" id="right-card">
      <div class="tabs">
        <button class="tab-button active" data-tab="details">Customer details</button>
        <button class="tab-button" data-tab="add">Add new customer</button>
        <button class="tab-button" data-tab="calendar">Calendar</button>
      </div>

      <!-- Details tab -->
      <div class="tab-panel active" id="tab-details">
        <h2>
          <span>Customer details</span>
          <button id="delete-customer-btn" class="danger" style="display:none;">Delete</button>
        </h2>
        <div id="no-customer" class="empty-state">
          Select a customer on the left, or add a new one in the "Add new customer" tab.
        </div>

        <div id="customer-detail" style="display:none;">
          <form id="edit-customer-form">
            <label for="edit-customer-name">Company name</label>
            <input type="text" id="edit-customer-name" required />
            <div class="mt-1 section-inline">
              <small class="muted">Edit the company name and click save.</small>
              <input type="submit" value="Save changes" />
            </div>
          </form>

          <div class="mt-2 section-inline">
            <div>
              <div class="muted">Primary contact</div>
              <div id="detail-contact-line" style="font-weight:500;"></div>
            </div>
            <div>
              <div class="muted">Next contact date</div>
              <div>
                <span id="detail-next-date" class="pill"></span>
              </div>
            </div>
          </div>

          <div class="mt-2">
            <h3>Contacts</h3>
            <div id="contacts-list" class="contacts-list"></div>
            <form id="add-contact-form" class="mt-1">
              <div class="form-row">
                <div>
                  <label for="add-contact-name">Name</label>
                  <input type="text" id="add-contact-name" placeholder="New contact name" />
                </div>
                <div>
                  <label for="add-contact-email">Email</label>
                  <input type="email" id="add-contact-email" placeholder="contact@example.com" />
                </div>
              </div>
              <div class="mt-1 section-inline">
                <small class="muted">Add alternates you may want to CC.</small>
                <input type="submit" value="Add contact" />
              </div>
            </form>
          </div>

          <div class="mt-2">
            <h3>Quick actions</h3>
            <div class="section-inline">
              <button id="mark-contacted-btn">âœ” Mark contacted today</button>
              <small id="detail-last-contact"></small>
            </div>
          </div>

          <div class="mt-2">
            <h3>Log a contact</h3>
            <form id="log-contact-form">
              <div class="form-row">
                <div>
                  <label for="log-date">Date of contact</label>
                  <input type="date" id="log-date" required />
                </div>
                <div>
                  <label for="log-action-type">What did you do?</label>
                  <select id="log-action-type">
                    <option value="Call">Call</option>
                    <option value="Email">Email</option>
                    <option value="Meeting">Meeting</option>
                    <option value="Demo">Demo</option>
                    <option value="Loom">Loom / Mojo video</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <label for="log-issue">Issue area (if they need help with something)</label>
              <input type="text" id="log-issue" placeholder="Onboarding, quoting, templates, etc." />

              <label for="log-notes">What was discussed?</label>
              <textarea id="log-notes" placeholder="Notes from the conversation..." required></textarea>

              <label for="log-url">Mojo / Loom / meeting URL</label>
              <input type="text" id="log-url" placeholder="https://..." />

              <label for="log-attachment-note">Attachment note</label>
              <input type="text" id="log-attachment-note" placeholder="e.g. Sample quote, screenshot, etc." />

              <div class="mt-1 section-inline">
                <small class="muted">
                  Files arenâ€™t uploaded to a server, but you can note what they sent and paste links.
                </small>
                <input type="submit" value="Save contact" />
              </div>
            </form>
          </div>

          <div class="mt-2">
            <h3>Contact history</h3>
            <div id="history-list" class="contact-history"></div>
          </div>
        </div>
      </div>

      <!-- Add customer tab -->
      <div class="tab-panel" id="tab-add">
        <h2>Add new customer</h2>
        <form id="new-customer-form">
          <div class="form-row">
            <div>
              <label for="new-customer-name">Customer name</label>
              <input type="text" id="new-customer-name" required />
            </div>
            <div>
              <label for="new-contact-name">Primary contact name</label>
              <input type="text" id="new-contact-name" required />
            </div>
          </div>
          <div class="form-row">
            <div>
              <label for="new-contact-email">Primary contact email</label>
              <input type="email" id="new-contact-email" required />
            </div>
            <div>
              <label for="new-contact-date">First contact date</label>
              <input type="date" id="new-contact-date" required />
            </div>
          </div>

          <label for="new-notes">What was discussed? (initial contact)</label>
          <textarea id="new-notes" required></textarea>

          <label for="new-issue">Issue area (if any)</label>
          <input type="text" id="new-issue" placeholder="Optional" />

          <label for="new-action-type">What did you do?</label>
          <select id="new-action-type">
            <option value="Call">Call</option>
            <option value="Email">Email</option>
            <option value="Meeting">Meeting</option>
            <option value="Demo">Demo</option>
            <option value="Loom">Loom / Mojo video</option>
            <option value="Other">Other</option>
          </select>

          <label for="new-url">Mojo / Loom / meeting URL</label>
          <input type="text" id="new-url" placeholder="https://..." />

          <label for="new-attachment-note">Attachment note</label>
          <input type="text" id="new-attachment-note" placeholder="e.g. Sample quote, screenshot, etc." />

          <div class="mt-1 section-inline">
            <small class="muted">New customers get a monthly follow-up starting from this first contact date.</small>
            <input type="submit" value="Add customer" />
          </div>
        </form>
      </div>

      <!-- Calendar tab -->
      <div class="tab-panel" id="tab-calendar">
        <h2>Calendar view</h2>
        <p class="muted">
          See who is due for a follow-up on each day. Click a name to open that customer.
        </p>
        <div class="calendar-header">
          <div class="calendar-title" id="calendar-month-label">Month</div>
          <div class="calendar-nav">
            <button id="calendar-prev">&lt;</button>
            <button id="calendar-next">&gt;</button>
          </div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="calendar-empty-note" id="calendar-empty-note">
          Customers with a next contact date this month will appear in the calendar.
        </div>
      </div>
    </section>
  </main>

  <script>
    // ===== Data & storage =====
    const STORAGE_KEY = "salesbuildr_followup_customers_v1";

    /** @type {Array} */
    let customers = [];
    let activeCustomerId = null;
    let searchQuery = "";
    let calendarCurrent = new Date();
    calendarCurrent.setDate(1);

    function createId(prefix = "c") {
      return prefix + "_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }

    function normalizeCustomers(list) {
      if (!Array.isArray(list)) return [];
      return list.map((c) => {
        // Ensure history array
        if (!Array.isArray(c.history)) {
          c.history = [];
        }

        // If contacts not yet introduced, migrate from old contactName/contactEmail
        if (!Array.isArray(c.contacts) || c.contacts.length === 0) {
          const contacts = [];
          if (c.contactName || c.contactEmail) {
            contacts.push({
              id: createId("ct"),
              name: c.contactName || "",
              email: c.contactEmail || "",
              isPrimary: true,
            });
          }
          c.contacts = contacts;
        }

        // Ensure exactly one primary if any contacts exist
        if (c.contacts.length > 0) {
          let hasPrimary = c.contacts.some((ct) => ct.isPrimary);
          if (!hasPrimary) {
            c.contacts[0].isPrimary = true;
          }
        }

        // Clean up old fields (optional)
        delete c.contactName;
        delete c.contactEmail;

        return c;
      });
    }

    function loadCustomers() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return normalizeCustomers(parsed);
      } catch (e) {
        console.error("Failed to parse stored customers", e);
        return [];
      }
    }

    function saveCustomers() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(customers));
      renderAll();
    }

    // ===== Date helpers =====
    function toIsoDate(date) {
      if (typeof date === "string") return date;
      const d = new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + day;
    }

    function parseIso(dateStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function formatDisplayDate(dateStr) {
      if (!dateStr) return "â€”";
      const d = parseIso(dateStr);
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function addOneMonthWeekday(dateStr) {
      if (!dateStr) return null;
      const d = parseIso(dateStr);
      const originalDay = d.getDate();
      d.setMonth(d.getMonth() + 1);

      // Handle end-of-month (e.g., Jan 31 + 1 month)
      if (d.getDate() < originalDay) {
        d.setDate(0);
      }

      // Move weekends to Monday
      const day = d.getDay(); // 0 = Sun, 6 = Sat
      if (day === 6) {
        d.setDate(d.getDate() + 2); // Saturday -> Monday
      } else if (day === 0) {
        d.setDate(d.getDate() + 1); // Sunday -> Monday
      }
      return toIsoDate(d);
    }

    function getThisWeekRange() {
      const today = new Date();
      const todayIdx = today.getDay(); // 0 Sun .. 6 Sat
      const distanceToMonday = (todayIdx + 6) % 7; // 0 if Monday
      const monday = new Date(today);
      monday.setDate(today.getDate() - distanceToMonday);
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      return {
        monday: toIsoDate(monday),
        friday: toIsoDate(friday),
        today: toIsoDate(today),
      };
    }

    function compareDates(a, b) {
      if (!a || !b) return 0;
      if (a < b) return -1;
      if (a > b) return 1;
      return 0;
    }

    // ===== Business logic =====
    function getPrimaryContact(customer) {
      if (!customer.contacts || customer.contacts.length === 0) return null;
      return customer.contacts.find((c) => c.isPrimary) || customer.contacts[0];
    }

    function getLastContactDate(customer) {
      if (!customer.history || customer.history.length === 0) return null;
      const sorted = [...customer.history].sort((a, b) => (a.date > b.date ? 1 : -1));
      return sorted[sorted.length - 1].date;
    }

    function getNextContactDate(customer) {
      const last = getLastContactDate(customer);
      if (!last) return null;
      return addOneMonthWeekday(last);
    }

    function classifyCustomerByDueDate(customer) {
      const next = getNextContactDate(customer);
      if (!next) return "later";
      const { monday, friday, today } = getThisWeekRange();

      if (compareDates(next, today) <= 0) {
        return "overdue"; // includes today
      }
      if (compareDates(next, today) > 0 && compareDates(next, friday) <= 0) {
        return "week";
      }
      return "later";
    }

    function getDueLabelAndClass(customer) {
      const next = getNextContactDate(customer);
      if (!next) return { label: "No contact yet", cls: "pill" };
      const { today } = getThisWeekRange();
      const cmp = compareDates(next, today);
      if (cmp < 0) return { label: "Overdue", cls: "pill overdue" };
      if (cmp === 0) return { label: "Today", cls: "pill today" };
      const bucket = classifyCustomerByDueDate(customer);
      if (bucket === "week") return { label: "This week", cls: "pill week" };
      return { label: "Later", cls: "pill" };
    }

    // ===== Rendering =====
    function renderDashboard() {
      const listOverdue = document.getElementById("list-overdue");
      const listWeek = document.getElementById("list-week");
      const listLater = document.getElementById("list-later");
      const searchEmpty = document.getElementById("search-empty");

      listOverdue.innerHTML = "";
      listWeek.innerHTML = "";
      listLater.innerHTML = "";

      let countOverdue = 0;
      let countWeek = 0;
      let countLater = 0;

      const q = (searchQuery || "").toLowerCase().trim();
      let filtered = [...customers];
      if (q) {
        filtered = filtered.filter((c) =>
          (c.customerName || "").toLowerCase().includes(q)
        );
      }

      const sortedCustomers = filtered.sort((a, b) => {
        const an = getNextContactDate(a) || "9999-12-31";
        const bn = getNextContactDate(b) || "9999-12-31";
        return an.localeCompare(bn);
      });

      sortedCustomers.forEach((c) => {
        const next = getNextContactDate(c);
        const bucket = classifyCustomerByDueDate(c);
        const { label, cls } = getDueLabelAndClass(c);
        const primary = getPrimaryContact(c);

        const li = document.createElement("li");
        li.dataset.id = c.id;
        if (c.id === activeCustomerId) li.classList.add("active");

        const title = document.createElement("div");
        title.className = "customer-title";
        title.textContent = c.customerName;

        const meta = document.createElement("div");
        meta.className = "customer-meta";
        const contactSpan = document.createElement("span");
        contactSpan.textContent = primary
          ? primary.name || primary.email || "Contact"
          : "No contact";
        const nextSpan = document.createElement("span");
        nextSpan.textContent = next ? formatDisplayDate(next) : "No next date";
        const tagSpan = document.createElement("span");
        const pill = document.createElement("span");
        pill.className = cls;
        pill.textContent = label;
        tagSpan.appendChild(pill);

        meta.appendChild(contactSpan);
        meta.appendChild(nextSpan);
        meta.appendChild(tagSpan);

        li.appendChild(title);
        li.appendChild(meta);

        li.addEventListener("click", () => {
          activeCustomerId = c.id;
          setActiveTab("details");
          renderAll();
        });

        if (bucket === "overdue") {
          listOverdue.appendChild(li);
          countOverdue++;
        } else if (bucket === "week") {
          listWeek.appendChild(li);
          countWeek++;
        } else {
          listLater.appendChild(li);
          countLater++;
        }
      });

      const searching = !!q;
      document.getElementById("empty-overdue").style.display =
        countOverdue || searching ? "none" : "block";
      document.getElementById("empty-week").style.display =
        countWeek || searching ? "none" : "block";
      document.getElementById("empty-later").style.display =
        countLater || searching ? "none" : "block";

      searchEmpty.style.display = searching && sortedCustomers.length === 0 ? "block" : "none";

      document.getElementById("customer-count").textContent = customers.length
        ? customers.length + " customers"
        : "No customers yet";
    }

    function renderContacts(customer) {
      const container = document.getElementById("contacts-list");
      container.innerHTML = "";

      if (!customer.contacts || customer.contacts.length === 0) {
        container.innerHTML = '<div class="muted">No contacts yet. Add at least one.</div>';
        return;
      }

      customer.contacts.forEach((ct) => {
        const item = document.createElement("div");
        item.className = "contact-item";

        const main = document.createElement("div");
        main.className = "contact-main";
        const nameDiv = document.createElement("div");
        nameDiv.className = "contact-name";
        nameDiv.textContent = ct.name || "(No name)";
        const emailDiv = document.createElement("div");
        emailDiv.className = "contact-email";
        emailDiv.textContent = ct.email || "";
        main.appendChild(nameDiv);
        main.appendChild(emailDiv);
        if (ct.isPrimary) {
          const primaryPill = document.createElement("span");
          primaryPill.className = "pill primary";
          primaryPill.textContent = "Primary";
          main.appendChild(primaryPill);
        }

        const actions = document.createElement("div");
        actions.className = "contact-actions";
        const primaryLabel = document.createElement("label");
        const radio = document.createElement("input");
        radio.type = "radio";
        radio.name = "primary-contact";
        radio.value = ct.id;
        radio.checked = !!ct.isPrimary;
        primaryLabel.appendChild(radio);
        primaryLabel.appendChild(document.createTextNode(" Primary"));

        radio.addEventListener("change", () => {
          customer.contacts.forEach((c) => {
            c.isPrimary = c.id === ct.id;
          });
          saveCustomers();
        });

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "Remove";
        removeBtn.addEventListener("click", () => {
          const ok = confirm("Remove this contact?");
          if (!ok) return;
          customer.contacts = customer.contacts.filter((c) => c.id !== ct.id);
          // Ensure a primary remains if any contact exists
          if (customer.contacts.length > 0 && !customer.contacts.some((c) => c.isPrimary)) {
            customer.contacts[0].isPrimary = true;
          }
          saveCustomers();
        });

        actions.appendChild(primaryLabel);
        actions.appendChild(removeBtn);

        item.appendChild(main);
        item.appendChild(actions);

        container.appendChild(item);
      });
    }

    function renderDetail() {
      const detailWrapper = document.getElementById("customer-detail");
      const noCustomer = document.getElementById("no-customer");
      const deleteBtn = document.getElementById("delete-customer-btn");

      const customer = customers.find((c) => c.id === activeCustomerId);
      if (!customer) {
        detailWrapper.style.display = "none";
        noCustomer.style.display = "block";
        deleteBtn.style.display = "none";
        return;
      }

      detailWrapper.style.display = "block";
      noCustomer.style.display = "none";
      deleteBtn.style.display = "inline-flex";

      document.getElementById("edit-customer-name").value = customer.customerName || "";

      const primary = getPrimaryContact(customer);
      const contactLine = primary
        ? (primary.name || "") + (primary.email ? " Â· " + primary.email : "")
        : "No contact info";
      document.getElementById("detail-contact-line").textContent = contactLine;

      const next = getNextContactDate(customer);
      const nextSpan = document.getElementById("detail-next-date");
      const { label, cls } = getDueLabelAndClass(customer);
      nextSpan.textContent = next ? formatDisplayDate(next) + " Â· " + label : "No next date";
      nextSpan.className = cls || "pill";

      const last = getLastContactDate(customer);
      const lastEl = document.getElementById("detail-last-contact");
      lastEl.textContent = last ? "Last contact: " + formatDisplayDate(last) : "No contact logged yet.";

      // Set default date in log form to today
      document.getElementById("log-date").value = toIsoDate(new Date());

      // Contacts
      renderContacts(customer);

      // Render history
      const historyList = document.getElementById("history-list");
      historyList.innerHTML = "";
      if (!customer.history || customer.history.length === 0) {
        historyList.innerHTML = '<div class="muted">No contacts logged yet.</div>';
      } else {
        const sorted = [...customer.history].sort((a, b) =>
          a.date < b.date ? 1 : a.date > b.date ? -1 : 0
        );
        sorted.forEach((item) => {
          const div = document.createElement("div");
          div.className = "history-item";

          const header = document.createElement("div");
          header.className = "history-header";
          const left = document.createElement("div");
          left.innerHTML = "<strong>" + formatDisplayDate(item.date) + "</strong>";
          const right = document.createElement("div");
          right.innerHTML =
            '<span class="pill">' + (item.actionType || "Contact") + "</span>";
          header.appendChild(left);
          header.appendChild(right);

          const body = document.createElement("div");
          body.className = "history-body";
          body.textContent = item.notes || "";

          const meta = document.createElement("div");
          meta.className = "history-meta";
          const parts = [];
          if (item.issueArea) parts.push("Issue: " + item.issueArea);
          if (item.attachmentNote) parts.push("Attachment: " + item.attachmentNote);
          meta.textContent = parts.join(" Â· ");

          const linkDiv = document.createElement("div");
          linkDiv.className = "history-link";
          if (item.meetingUrl) {
            const a = document.createElement("a");
            a.href = item.meetingUrl;
            a.target = "_blank";
            a.rel = "noopener noreferrer";
            a.textContent = item.meetingUrl;
            linkDiv.appendChild(a);
          }

          div.appendChild(header);
          div.appendChild(body);
          if (parts.length) div.appendChild(meta);
          if (item.meetingUrl) div.appendChild(linkDiv);
          historyList.appendChild(div);
        });
      }
    }

    function renderCalendar() {
      const grid = document.getElementById("calendar-grid");
      const label = document.getElementById("calendar-month-label");
      const emptyNote = document.getElementById("calendar-empty-note");
      if (!grid || !label) return;

      const year = calendarCurrent.getFullYear();
      const month = calendarCurrent.getMonth(); // 0-based
      label.textContent = calendarCurrent.toLocaleDateString(undefined, {
        month: "long",
        year: "numeric",
      });

      grid.innerHTML = "";
      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

      // Day name headers
      dayNames.forEach((name) => {
        const div = document.createElement("div");
        div.className = "calendar-day-name";
        div.textContent = name;
        grid.appendChild(div);
      });

      const firstDay = new Date(year, month, 1);
      const startWeekday = firstDay.getDay(); // 0-6
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const todayIso = toIsoDate(new Date());

      // Leading empty cells
      for (let i = 0; i < startWeekday; i++) {
        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        grid.appendChild(cell);
      }

      let hasEntries = false;

      for (let day = 1; day <= daysInMonth; day++) {
        const cellDate = new Date(year, month, day);
        const cellIso = toIsoDate(cellDate);

        const cell = document.createElement("div");
        cell.className = "calendar-cell";
        if (cellIso === todayIso) {
          cell.classList.add("today");
        }

        const header = document.createElement("div");
        header.className = "calendar-cell-header";
        const dayNumber = document.createElement("span");
        dayNumber.textContent = day;
        const weekday = document.createElement("span");
        weekday.textContent = dayNames[cellDate.getDay()];
        header.appendChild(dayNumber);
        header.appendChild(weekday);
        cell.appendChild(header);

        const dueCustomers = customers.filter(
          (c) => getNextContactDate(c) === cellIso
        );

        if (dueCustomers.length > 0) {
          hasEntries = true;
        }

        dueCustomers.forEach((c) => {
          const entry = document.createElement("div");
          entry.className = "calendar-entry";
          entry.textContent = c.customerName;
          entry.title = c.customerName;
          entry.addEventListener("click", () => {
            activeCustomerId = c.id;
            setActiveTab("details");
            renderAll();
          });
          cell.appendChild(entry);
        });

        grid.appendChild(cell);
      }

      emptyNote.style.display = hasEntries ? "none" : "block";
    }

    function renderAll() {
      renderDashboard();
      renderDetail();
      renderCalendar();
    }

    // ===== Tabs =====
    function setActiveTab(tabName) {
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.tab === tabName);
      });
      document.querySelectorAll(".tab-panel").forEach((panel) => {
        panel.classList.toggle("active", panel.id === "tab-" + tabName);
      });
    }

    function setupTabs() {
      document.querySelectorAll(".tab-button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          setActiveTab(tab);
        });
      });
    }

    // ===== Event handlers =====
    function setupNewCustomerForm() {
      const form = document.getElementById("new-customer-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const customerName = document.getElementById("new-customer-name").value.trim();
        const contactName = document.getElementById("new-contact-name").value.trim();
        const contactEmail = document.getElementById("new-contact-email").value.trim();
        const contactDate = document.getElementById("new-contact-date").value;
        const notes = document.getElementById("new-notes").value.trim();
        const issue = document.getElementById("new-issue").value.trim();
        const actionType = document.getElementById("new-action-type").value;
        const url = document.getElementById("new-url").value.trim();
        const attachmentNote = document.getElementById("new-attachment-note").value.trim();

        if (!customerName || !contactName || !contactEmail || !contactDate || !notes) {
          alert("Please fill in customer name, primary contact name, email, first contact date and notes.");
          return;
        }

        const customerId = createId("c");
        const historyEntry = {
          id: createId("h"),
          date: contactDate,
          notes,
          issueArea: issue || "",
          actionType,
          meetingUrl: url || "",
          attachmentNote: attachmentNote || "",
        };

        const newCustomer = {
          id: customerId,
          customerName,
          createdAt: toIsoDate(new Date()),
          contacts: [
            {
              id: createId("ct"),
              name: contactName,
              email: contactEmail,
              isPrimary: true,
            },
          ],
          history: [historyEntry],
        };

        customers.push(newCustomer);
        activeCustomerId = customerId;
        saveCustomers();

        form.reset();
        document.getElementById("new-contact-date").value = contactDate;
        setActiveTab("details");
      });
    }

    function setupLogContactForm() {
      const form = document.getElementById("log-contact-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const customer = customers.find((c) => c.id === activeCustomerId);
        if (!customer) return;

        const date = document.getElementById("log-date").value;
        const actionType = document.getElementById("log-action-type").value;
        const issue = document.getElementById("log-issue").value.trim();
        const notes = document.getElementById("log-notes").value.trim();
        const url = document.getElementById("log-url").value.trim();
        const attachmentNote = document.getElementById("log-attachment-note").value.trim();

        if (!date || !notes) {
          alert("Please add a date and some notes.");
          return;
        }

        const entry = {
          id: createId("h"),
          date,
          notes,
          issueArea: issue || "",
          actionType,
          meetingUrl: url || "",
          attachmentNote: attachmentNote || "",
        };

        if (!Array.isArray(customer.history)) customer.history = [];
        customer.history.push(entry);

        document.getElementById("log-issue").value = "";
        document.getElementById("log-notes").value = "";
        document.getElementById("log-url").value = "";
        document.getElementById("log-attachment-note").value = "";

        saveCustomers();
      });
    }

    function setupMarkContactedButton() {
      const btn = document.getElementById("mark-contacted-btn");
      btn.addEventListener("click", () => {
        const customer = customers.find((c) => c.id === activeCustomerId);
        if (!customer) return;
        const today = toIsoDate(new Date());
        const entry = {
          id: createId("h"),
          date: today,
          notes: "Quick check-in logged from dashboard.",
          issueArea: "",
          actionType: "Check-in",
          meetingUrl: "",
          attachmentNote: "",
        };
        if (!Array.isArray(customer.history)) customer.history = [];
        customer.history.push(entry);
        saveCustomers();
      });
    }

    function setupDeleteCustomerButton() {
      const btn = document.getElementById("delete-customer-btn");
      btn.addEventListener("click", () => {
        const customer = customers.find((c) => c.id === activeCustomerId);
        if (!customer) return;
        const ok = confirm("Delete customer '" + customer.customerName + "'? This cannot be undone.");
        if (!ok) return;
        customers = customers.filter((c) => c.id !== customer.id);
        activeCustomerId = customers.length ? customers[0].id : null;
        saveCustomers();
      });
    }

    function setupBackupButtons() {
      const exportBtn = document.getElementById("export-btn");
      const importInput = document.getElementById("import-input");

      exportBtn.addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(customers, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const stamp = new Date().toISOString().slice(0, 10);
        a.download = "salesbuildr-followup-backup-" + stamp + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

      importInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            if (!Array.isArray(data)) {
              alert("Invalid backup file.");
              return;
            }
            const ok = confirm(
              "Importing a backup will replace your current data. Continue?"
            );
            if (!ok) return;
            customers = normalizeCustomers(data);
            activeCustomerId = customers.length ? customers[0].id : null;
            saveCustomers();
            importInput.value = "";
          } catch (err) {
            console.error(err);
            alert("Failed to read backup file.");
          }
        };
        reader.readAsText(file);
      });
    }

    function setupSearch() {
      const input = document.getElementById("search-input");
      input.addEventListener("input", () => {
        searchQuery = input.value || "";
        renderDashboard();
      });
    }

    function setupCalendarNav() {
      document.getElementById("calendar-prev").addEventListener("click", () => {
        calendarCurrent.setMonth(calendarCurrent.getMonth() - 1);
        renderCalendar();
      });
      document.getElementById("calendar-next").addEventListener("click", () => {
        calendarCurrent.setMonth(calendarCurrent.getMonth() + 1);
        renderCalendar();
      });
    }

    function setupEditCustomerForm() {
      const form = document.getElementById("edit-customer-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const customer = customers.find((c) => c.id === activeCustomerId);
        if (!customer) return;
        const name = document.getElementById("edit-customer-name").value.trim();
        if (!name) {
          alert("Company name cannot be empty.");
          return;
        }
        customer.customerName = name;
        saveCustomers();
      });
    }

    function setupAddContactForm() {
      const form = document.getElementById("add-contact-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const customer = customers.find((c) => c.id === activeCustomerId);
        if (!customer) return;
        const name = document.getElementById("add-contact-name").value.trim();
        const email = document.getElementById("add-contact-email").value.trim();
        if (!name && !email) {
          alert("Please enter at least a name or an email for the contact.");
          return;
        }
        const contact = {
          id: createId("ct"),
          name,
          email,
          isPrimary: !customer.contacts || customer.contacts.length === 0,
        };
        if (!Array.isArray(customer.contacts)) {
          customer.contacts = [];
        }
        customer.contacts.push(contact);
        document.getElementById("add-contact-name").value = "";
        document.getElementById("add-contact-email").value = "";
        saveCustomers();
      });
    }

    // ===== Init =====
    document.addEventListener("DOMContentLoaded", () => {
      customers = loadCustomers();
      if (customers.length) {
        activeCustomerId = customers[0].id;
      }

      setupTabs();
      setupNewCustomerForm();
      setupLogContactForm();
      setupMarkContactedButton();
      setupDeleteCustomerButton();
      setupBackupButtons();
      setupSearch();
      setupCalendarNav();
      setupEditCustomerForm();
      setupAddContactForm();

      renderAll();
    });
  </script>
</body>
</html>
