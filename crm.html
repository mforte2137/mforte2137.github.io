<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Salesbuildr Customer Follow-up CRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f5f7;
      --panel: #ffffff;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --border: #e2e8f0;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
      --radius-lg: 12px;
      --radius-xl: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 40%, #f4f5f7 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    header {
      margin-bottom: 16px;
    }

    header h1 {
      margin: 0;
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }

    header p {
      margin: 6px 0 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .tabs {
      display: inline-flex;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border-radius: 999px;
      padding: 4px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 14px;
      cursor: pointer;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .tab-btn span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
    }

    main {
      margin-top: 4px;
    }

    .tab-content {
      display: none;
      background: rgba(255,255,255,0.95);
      border-radius: var(--radius-xl);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12);
      padding: 20px 18px;
    }

    .tab-content.active {
      display: block;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 18px;
    }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--panel);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 14px 14px 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .card-header h3 {
      margin: 0;
      font-size: 15px;
    }

    .card-header small {
      color: var(--text-muted);
      font-size: 12px;
    }

    .pill {
      border-radius: 999px;
      font-size: 11px;
      padding: 2px 8px;
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(37, 99, 235, 0.3);
      white-space: nowrap;
    }

    label {
      display: block;
      font-size: 13px;
      margin-top: 8px;
      margin-bottom: 4px;
      font-weight: 500;
    }

    input[type="text"],
    input[type="email"],
    input[type="url"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 13px;
      font-family: inherit;
      background: #f9fafb;
    }

    textarea {
      min-height: 70px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent);
      background: #fff;
    }

    .field-row {
      display: grid;
      gap: 10px;
    }

    .field-row-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .muted {
      font-size: 12px;
      color: var(--text-muted);
    }

    .plans-container {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .plan-badge {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 10px;
      font-size: 12px;
      background: #f9fafb;
      cursor: pointer;
    }

    .plan-badge.selected {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 4px 10px rgba(37,99,235,0.35);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
    }

    .btn-sm {
      padding: 4px 9px;
      font-size: 12px;
    }

    .btn-danger {
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
    }

    .tag {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f3f4f6;
      color: #111827;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .tag-accent {
      background: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(37,99,235,0.35);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 4px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .table-scroll {
      max-height: 280px;
      overflow: auto;
    }

    .pill-status {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #f3f4f6;
    }

    .pill-status.due {
      background: #fee2e2;
      color: var(--danger);
    }

    .pill-status.ok {
      background: #dcfce7;
      color: var(--success);
    }

    /* Calendar */
    .calendar-wrapper {
      display: grid;
      grid-template-columns: 2fr 1.2fr;
      gap: 16px;
    }

    @media (max-width: 960px) {
      .calendar-wrapper {
        grid-template-columns: 1fr;
      }
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .calendar-header h3 {
      margin: 0;
      font-size: 15px;
    }

    .calendar-nav button {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 4px 9px;
      font-size: 12px;
      cursor: pointer;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .calendar-day-name {
      text-align: center;
      color: var(--text-muted);
      font-weight: 500;
      padding-bottom: 4px;
    }

    .calendar-cell {
      background: #f9fafb;
      border-radius: 10px;
      min-height: 70px;
      padding: 4px;
      position: relative;
      border: 1px solid #e5e7eb;
      cursor: default;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .calendar-cell.has-contacts {
      background: #eff6ff;
      border-color: var(--accent-soft);
      cursor: pointer;
    }

    .calendar-day-number {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-main);
    }

    .calendar-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      position: absolute;
      top: 4px;
      right: 4px;
    }

    .calendar-cell .mini-label {
      font-size: 10px;
      color: var(--accent);
      margin-top: auto;
    }

    .day-details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .day-details-header h4 {
      margin: 0;
      font-size: 14px;
    }

    .history-list {
      font-size: 12px;
      max-height: 150px;
      overflow-y: auto;
    }

    .history-item {
      border-radius: 8px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      margin-bottom: 6px;
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 2px;
      color: var(--text-muted);
    }

    .badge-frequency {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      background: #eef2ff;
      color: #4338ca;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .stat-chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: #f3f4f6;
      color: var(--text-muted);
    }

    .stat-chip strong {
      color: var(--text-main);
    }

    .divider {
      border-top: 1px dashed #e5e7eb;
      margin: 8px 0 10px;
    }

    .list-compact {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 12px;
    }

    .list-compact li {
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .list-compact li:last-child {
      border-bottom: none;
    }

    .text-link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
    }

    /* Overview tab */
    .overview-item {
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      margin-bottom: 6px;
      font-size: 13px;
      cursor: pointer;
      background: #f9fafb;
    }

    .overview-item.selected {
      border-color: var(--accent);
      background: #eff6ff;
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .overview-item .muted {
      font-size: 11px;
    }

    /* Tasks tab */
    .task-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .task-filter-btn {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f9fafb;
      cursor: pointer;
    }

    .task-filter-btn.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    /* Contacts editor (inline) */
    .contacts-list {
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #f9fafb;
      padding: 6px;
      max-height: 180px;
      overflow-y: auto;
      font-size: 12px;
      margin-top: 4px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }

    .contact-item:last-child {
      border-bottom: none;
    }

    .contact-main {
      flex: 1;
    }

    .contact-main-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      margin-bottom: 2px;
    }

    .contact-main-row input {
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 6px;
      background: #fff;
    }

    .contact-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .contact-actions label {
      margin: 0;
      font-size: 11px;
      font-weight: 400;
    }

    .contact-actions button {
      padding: 2px 6px;
      font-size: 11px;
      border-radius: 999px;
      background: #fee2e2;
      color: var(--danger);
      border: 1px solid #fecaca;
      cursor: pointer;
    }
        .backup-controls {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 12px;
    }

    .backup-controls span {
      font-size: 11px;
    }

  </style>
</head>
<body>
<div class="app">
   <header>
    <h1>
      <span class="logo-dot"></span>
      Salesbuildr Customer Follow-up
    </h1>
    <p>Lightweight CRM to keep monthly (or weekly/bi-weekly) contact with your customers.</p>

    <div class="backup-controls">
      <button class="btn btn-secondary btn-sm" type="button" id="exportDataBtn">
        Export data
      </button>
      <button class="btn btn-ghost btn-sm" type="button" id="importDataBtn">
        Import data
      </button>
      <input type="file" id="importDataInput" accept="application/json" style="display:none;" />
      <span class="muted" id="backupStatus"></span>
    </div>
  </header>


  <nav class="tabs">
    <button class="tab-btn active" data-tab="dashboard">
      <span class="dot"></span> Dashboard
    </button>
    <button class="tab-btn" data-tab="customers">
      <span class="dot"></span> Customers
    </button>
    <button class="tab-btn" data-tab="overview">
      <span class="dot"></span> Overview
    </button>
    <button class="tab-btn" data-tab="calendar">
      <span class="dot"></span> Calendar
    </button>
    <button class="tab-btn" data-tab="tasks">
      <span class="dot"></span> Tasks
    </button>
  </nav>

  <main>
    <!-- DASHBOARD TAB -->
    <section id="dashboard" class="tab-content active">
      <div class="grid-2">
        <!-- Left: Due / Overdue contacts -->
              <div class="card">
          <div class="card-header">
            <h3>Contacts due</h3>
            <small>Today & overdue</small>
          </div>
          <div class="stats-row" id="dashboardStats"></div>
          <div class="divider"></div>
          <div id="dueList"></div>

          <!-- Recent interactions snapshot -->
          <div class="divider"></div>
          <div>
            <div class="card-header" style="margin-top:4px; margin-bottom:4px; padding:0; border:none;">
              <h3 style="font-size:14px;">Recent interactions</h3>
              <small>Last 5 notes</small>
            </div>
            <div id="recentInteractions"></div>
          </div>
        </div>


        <!-- Right: Schedule + interaction panel -->
        <div class="card">
          <div class="card-header">
            <h3>Schedule & last interaction</h3>
            <small>Select a customer to manage cadence</small>
          </div>

          <label for="scheduleCustomerSelect">Customer</label>
          <select id="scheduleCustomerSelect">
            <option value="">Select a customer…</option>
          </select>

          <div id="scheduleDetails" class="muted" style="margin-top:6px;"></div>

          <div class="field-row field-row-2" style="margin-top:6px;">
            <div>
              <label for="frequencySelect">Contact frequency</label>
              <select id="frequencySelect">
                <option value="monthly">Monthly</option>
                <option value="biweekly">Every 2 weeks</option>
                <option value="weekly">Weekly</option>
              </select>
            </div>
            <div>
              <label for="nextContactInput">Next contact date</label>
              <input type="date" id="nextContactInput" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <button class="btn btn-primary btn-sm" type="button" id="saveScheduleBtn">
              Save schedule
            </button>
          </div>

          <div class="divider"></div>

          <div id="interactionPanel">
            <p class="muted">Pick a customer from the list of due contacts, Overview, or the calendar to log new notes.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- CUSTOMERS TAB -->
    <section id="customers" class="tab-content">
      <div class="grid-2">
        <!-- Customer basics form -->
        <div class="card">
          <div class="card-header">
            <h3>Customer basics</h3>
            <small>No scheduling here – just core info.</small>
          </div>
          <form id="customerForm">
            <input type="hidden" id="customerId" />

            <label for="companyName">Company name</label>
            <input type="text" id="companyName" required />

            <div class="field-row field-row-2">
              <div>
                <label for="primaryContactName">Primary contact name</label>
                <input type="text" id="primaryContactName" />
              </div>
              <div>
                <label for="primaryContactEmail">Primary contact email</label>
                <input type="email" id="primaryContactEmail" />
              </div>
            </div>

            <!-- Contacts editor -->
            <label style="margin-top:10px;">Additional contacts</label>
            <p class="muted">Use this list to manage extra contacts and CCs. One will be marked as primary.</p>
            <div id="contactsList" class="contacts-list">
              <p class="muted" style="margin:0;">Save the customer first to add contacts.</p>
            </div>
            <div class="field-row field-row-2" style="margin-top:6px;">
              <div>
                <label for="addContactName">New contact name</label>
                <input type="text" id="addContactName" />
              </div>
              <div>
                <label for="addContactEmail">New contact email</label>
                <input type="email" id="addContactEmail" />
              </div>
            </div>
            <div style="margin-top:6px;">
              <button class="btn btn-secondary btn-sm" type="button" id="addContactBtn">
                Add contact
              </button>
            </div>

            <label for="tenantUrl">URL to tenant portal</label>
            <input type="url" id="tenantUrl" placeholder="https://…" />

            <label for="psaSelect">PSA</label>
            <select id="psaSelect">
              <option value="">– Select PSA –</option>
              <option value="Autotask">Autotask</option>
              <option value="ConnectWise">ConnectWise</option>
              <option value="Halo">Halo</option>
              <option value="API">API</option>
            </select>
            <p class="muted">Each tenant integrates with a single PSA.</p>

            <label>Plan selection</label>
            <div class="plans-container" id="plansContainer">
              <button type="button" class="plan-badge" data-plan="Standard">Standard</button>
              <button type="button" class="plan-badge" data-plan="Advanced">Advanced</button>
              <button type="button" class="plan-badge" data-plan="Premium">Premium</button>
              <button type="button" class="plan-badge" data-plan="Storefront">Storefront</button>
              <button type="button" class="plan-badge" data-plan="Procurement">Procurement</button>
              <button type="button" class="plan-badge" data-plan="Advanced workflow">Advanced workflow</button>
              <button type="button" class="plan-badge" data-plan="Import/Export">Import/Export</button>
              <button type="button" class="plan-badge" data-plan="Whitespace">Whitespace</button>
            </div>
            <p class="muted">Selected plans will appear as badges like [Premium] [Storefront].</p>

            <label for="customerNotes">Notes</label>
            <textarea id="customerNotes" placeholder="Special notes, context, or anything unique about this customer."></textarea>

            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="submit" id="saveCustomerBtn">
                Save customer
              </button>
              <button class="btn btn-secondary" type="button" id="clearCustomerBtn">
                Clear form
              </button>
            </div>
          </form>
        </div>

        <!-- Customer list -->
        <div class="card">
          <div class="card-header">
            <h3>Customer list</h3>
            <small>Edit basics or jump to scheduling.</small>
          </div>
          <div class="table-scroll">
            <table>
              <thead>
              <tr>
                <th>Company</th>
                <th>Primary contact</th>
                <th>Plans / PSA</th>
                <th>Next contact</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="customerTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- OVERVIEW TAB -->
    <section id="overview" class="tab-content">
      <div class="grid-2">
        <!-- Left: search + customer list -->
        <div class="card">
          <div class="card-header">
            <h3>Customer search</h3>
            <small>Find a customer and see their history.</small>
          </div>
          <label for="overviewSearchInput">Search by company name</label>
          <input type="text" id="overviewSearchInput" placeholder="Type to filter…" />
          <div class="divider"></div>
          <div id="overviewCustomerList"></div>
        </div>

        <!-- Right: overview / history -->
        <div class="card">
          <div class="card-header">
            <h3>Overview</h3>
            <small>Quick refresher of meetings & notes.</small>
          </div>
          <div id="overviewDetails" class="muted">
            Select a customer on the left to see their history.
          </div>
        </div>
      </div>
    </section>

    <!-- CALENDAR TAB -->
    <section id="calendar" class="tab-content">
      <div class="calendar-wrapper">
        <div class="card">
          <div class="calendar-header">
            <h3 id="calendarMonthLabel">Calendar</h3>
            <div class="calendar-nav">
              <button type="button" id="prevMonthBtn">&lt;</button>
              <button type="button" id="todayMonthBtn">Today</button>
              <button type="button" id="nextMonthBtn">&gt;</button>
            </div>
          </div>
          <div class="calendar-grid" id="calendarGridNames">
            <div class="calendar-day-name">Sun</div>
            <div class="calendar-day-name">Mon</div>
            <div class="calendar-day-name">Tue</div>
            <div class="calendar-day-name">Wed</div>
            <div class="calendar-day-name">Thu</div>
            <div class="calendar-day-name">Fri</div>
            <div class="calendar-day-name">Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGridDays"></div>
        </div>

        <div class="card">
          <div class="day-details-header">
            <h4 id="dayDetailsTitle">Select a day</h4>
            <span class="pill" id="dayDetailsCount">0 customers</span>
          </div>
          <div id="dayDetailsContent" class="muted">
            Click a highlighted calendar day to see customers due for follow-up.
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS TAB -->
    <section id="tasks" class="tab-content">
      <div class="grid-2">
        <!-- Left: add/edit task -->
        <div class="card">
          <div class="card-header">
            <h3>New task</h3>
            <small>Follow-ups from meetings.</small>
          </div>
          <form id="taskForm">
            <label for="taskCustomerSelect">Customer</label>
            <select id="taskCustomerSelect">
              <option value="">Select a customer…</option>
            </select>

            <label for="taskDescription">What do you need to do?</label>
            <textarea id="taskDescription" placeholder="Research, gather updates, record Loom, etc."></textarea>

            <label for="taskDueDate">Due date</label>
            <input type="date" id="taskDueDate" />

            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
              <button class="btn btn-primary" type="submit">Add task</button>
            </div>
          </form>
        </div>

        <!-- Right: task list -->
        <div class="card">
          <div class="card-header">
            <h3>Task list</h3>
            <small>Keep an eye on open actions.</small>
          </div>
          <div class="task-filters">
            <button type="button" class="task-filter-btn active" data-filter="open">Open</button>
            <button type="button" class="task-filter-btn" data-filter="completed">Completed</button>
            <button type="button" class="task-filter-btn" data-filter="all">All</button>
          </div>
          <div class="stats-row" id="taskStats"></div>
          <div class="divider"></div>
          <div class="table-scroll">
            <table>
              <thead>
              <tr>
                <th>Company</th>
                <th>Task</th>
                <th>Due</th>
                <th>Status</th>
                <th></th>
              </tr>
              </thead>
              <tbody id="taskTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  (function () {
    const STORAGE_KEY = 'salesbuildr_crm_v3';

    let customers = [];
    let tasks = [];
    let currentCalendarMonth;
    let currentCalendarYear;
    let selectedOverviewCustomerId = null;
    let taskFilter = 'open';

    /* -------- Helpers for contacts & PSA -------- */

    function createId(prefix) {
      return prefix + '_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8);
    }

    function getPrimaryContact(customer) {
      if (!customer || !Array.isArray(customer.contacts)) return null;
      return customer.contacts.find(c => c.isPrimary) || customer.contacts[0] || null;
    }

    function normalizeCustomersArray(list) {
      if (!Array.isArray(list)) return [];

      return list.map(c => {
        // contacts array from legacy fields
        if (!Array.isArray(c.contacts) || !c.contacts.length) {
          const contacts = [];
          if (c.primaryContactName || c.primaryContactEmail) {
            contacts.push({
              id: createId('ct'),
              name: c.primaryContactName || '',
              email: c.primaryContactEmail || '',
              isPrimary: true
            });
          }
          if (c.additionalContactName || c.additionalContactEmail) {
            contacts.push({
              id: createId('ct'),
              name: c.additionalContactName || '',
              email: c.additionalContactEmail || '',
              isPrimary: contacts.length === 0 // if no primary yet
            });
          }
          c.contacts = contacts;
        }

        // ensure one primary if contacts exist
        if (Array.isArray(c.contacts) && c.contacts.length) {
          if (!c.contacts.some(ct => ct.isPrimary)) {
            c.contacts[0].isPrimary = true;
          }
        }

        // PSA default
        if (typeof c.psa !== 'string') {
          c.psa = '';
        }

        return c;
      });
    }

    /* -------- Storage & dates -------- */

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          customers = [];
          tasks = [];
        } else {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            customers = parsed;
            tasks = [];
          } else {
            customers = parsed.customers || [];
            tasks = parsed.tasks || [];
          }
        }
      } catch (e) {
        customers = [];
        tasks = [];
      }
      customers = normalizeCustomersArray(customers);
    }

    function syncTaskCompanyNames() {
      tasks.forEach(t => {
        if (t.customerId) {
          const c = customers.find(c => c.id === t.customerId);
          if (c) t.companyName = c.companyName;
        }
      });
    }

    function saveState() {
      syncTaskCompanyNames();
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ customers, tasks }));
      renderAll();
    }

    function formatDate(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function parseDate(str) {
      if (!str) return null;
      const [y, m, d] = str.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function addMonths(date, months) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    function computeNextContactDate(fromDate, frequency) {
      if (!fromDate) fromDate = new Date();
      if (frequency === 'weekly') return formatDate(addDays(fromDate, 7));
      if (frequency === 'biweekly') return formatDate(addDays(fromDate, 14));
      return formatDate(addMonths(fromDate, 1)); // monthly default
    }

    function getTodayStr() {
      return formatDate(new Date());
    }
    /* -------- Backup / export / import -------- */

    function showBackupStatus(message, isError) {
      const el = document.getElementById('backupStatus');
      if (!el) return;
      el.textContent = message;
      el.style.color = isError ? '#b91c1c' : 'var(--text-muted)';
      // Clear after a few seconds
      setTimeout(() => {
        if (el.textContent === message) {
          el.textContent = '';
          el.style.color = 'var(--text-muted)';
        }
      }, 4000);
    }

    function exportData() {
      try {
        const payload = { customers, tasks };
        const json = JSON.stringify(payload, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `salesbuildr-crm-backup-${getTodayStr()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showBackupStatus('Data exported.', false);
      } catch (e) {
        console.error(e);
        showBackupStatus('Export failed.', true);
      }
    }

    function importDataFromFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const parsed = JSON.parse(text);

          if (!parsed || typeof parsed !== 'object') {
            throw new Error('Invalid file format.');
          }

          const importedCustomers = normalizeCustomersArray(parsed.customers || []);
          const importedTasks = Array.isArray(parsed.tasks) ? parsed.tasks : [];

          if (!confirm('Importing will replace your current customers and tasks. Continue?')) {
            return;
          }

          customers = importedCustomers;
          tasks = importedTasks;
          saveState();
          showBackupStatus('Data imported successfully.', false);
        } catch (err) {
          console.error(err);
          showBackupStatus('Import failed. Check the file.', true);
        }
      };
      reader.onerror = () => {
        showBackupStatus('Could not read file.', true);
      };
      reader.readAsText(file);
    }

    function setupBackupControls() {
      const exportBtn = document.getElementById('exportDataBtn');
      const importBtn = document.getElementById('importDataBtn');
      const input = document.getElementById('importDataInput');

      if (exportBtn) {
        exportBtn.addEventListener('click', exportData);
      }

      if (importBtn && input) {
        importBtn.addEventListener('click', () => input.click());

        input.addEventListener('change', (e) => {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          importDataFromFile(file);
          input.value = ''; // reset so same file can be chosen again
        });
      }
    }

    /* -------- Tabs -------- */
    function setupTabs() {
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabContents = document.querySelectorAll('.tab-content');

      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.tab;
          tabButtons.forEach(b => b.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(target).classList.add('active');
        });
      });
    }

    /* -------- Customers tab: basics form + list + contacts editor -------- */

    function getSelectedPlans() {
      const badges = document.querySelectorAll('.plan-badge.selected');
      return Array.from(badges).map(b => b.dataset.plan);
    }

    function setSelectedPlans(plans) {
      document.querySelectorAll('.plan-badge').forEach(b => {
        if (plans && plans.includes(b.dataset.plan)) {
          b.classList.add('selected');
        } else {
          b.classList.remove('selected');
        }
      });
    }

    function clearContactsEditor() {
      const list = document.getElementById('contactsList');
      if (list) {
        list.innerHTML = '<p class="muted" style="margin:0;">Save the customer first to add contacts.</p>';
      }
    }

    function clearCustomerForm() {
      document.getElementById('customerId').value = '';
      document.getElementById('companyName').value = '';
      document.getElementById('primaryContactName').value = '';
      document.getElementById('primaryContactEmail').value = '';
      document.getElementById('tenantUrl').value = '';
      document.getElementById('psaSelect').value = '';
      document.getElementById('customerNotes').value = '';
      document.getElementById('addContactName').value = '';
      document.getElementById('addContactEmail').value = '';
      setSelectedPlans([]);
      clearContactsEditor();
      document.getElementById('saveCustomerBtn').textContent = 'Save customer';
    }

    function populateContactsEditor(customer) {
      const container = document.getElementById('contactsList');
      if (!container) return;

      if (!customer || !Array.isArray(customer.contacts)) {
        clearContactsEditor();
        return;
      }

      const contacts = customer.contacts;
      if (!contacts.length) {
        container.innerHTML = '<p class="muted" style="margin:0;">No additional contacts yet. Add them below.</p>';
        return;
      }

      container.innerHTML = '';
      contacts.forEach(ct => {
        const item = document.createElement('div');
        item.className = 'contact-item';

        const main = document.createElement('div');
        main.className = 'contact-main';

        const row = document.createElement('div');
        row.className = 'contact-main-row';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Name';
        nameInput.value = ct.name || '';
        nameInput.addEventListener('change', () => {
          ct.name = nameInput.value.trim();
          // keep primary fields in sync
          const primary = getPrimaryContact(customer);
          if (primary && primary.id === ct.id) {
            document.getElementById('primaryContactName').value = ct.name || '';
          }
          saveState();
        });

        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.placeholder = 'Email';
        emailInput.value = ct.email || '';
        emailInput.addEventListener('change', () => {
          ct.email = emailInput.value.trim();
          const primary = getPrimaryContact(customer);
          if (primary && primary.id === ct.id) {
            document.getElementById('primaryContactEmail').value = ct.email || '';
          }
          saveState();
        });

        row.appendChild(nameInput);
        row.appendChild(emailInput);
        main.appendChild(row);

        if (ct.isPrimary) {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.textContent = 'Primary';
          pill.style.fontSize = '10px';
          main.appendChild(pill);
        }

        const actions = document.createElement('div');
        actions.className = 'contact-actions';

        const label = document.createElement('label');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'primary-contact';
        radio.checked = !!ct.isPrimary;
        radio.addEventListener('change', () => {
          customer.contacts.forEach(c => {
            c.isPrimary = c.id === ct.id;
          });
          // sync primary fields
          document.getElementById('primaryContactName').value = ct.name || '';
          document.getElementById('primaryContactEmail').value = ct.email || '';
          saveState();
          populateContactsEditor(customer);
        });
        label.appendChild(radio);
        label.appendChild(document.createTextNode(' Primary'));

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
          if (!confirm('Remove this contact?')) return;
          customer.contacts = customer.contacts.filter(c => c.id !== ct.id);
          if (customer.contacts.length && !customer.contacts.some(c => c.isPrimary)) {
            customer.contacts[0].isPrimary = true;
          }
          const primary = getPrimaryContact(customer);
          document.getElementById('primaryContactName').value = primary ? (primary.name || '') : '';
          document.getElementById('primaryContactEmail').value = primary ? (primary.email || '') : '';
          saveState();
          populateContactsEditor(customer);
        });

        actions.appendChild(label);
        actions.appendChild(removeBtn);

        item.appendChild(main);
        item.appendChild(actions);
        container.appendChild(item);
      });
    }

    function populateCustomerForm(customer) {
      document.getElementById('customerId').value = customer.id;
      document.getElementById('companyName').value = customer.companyName || '';
      const primary = getPrimaryContact(customer);
      document.getElementById('primaryContactName').value = primary ? (primary.name || '') : '';
      document.getElementById('primaryContactEmail').value = primary ? (primary.email || '') : '';
      document.getElementById('tenantUrl').value = customer.tenantUrl || '';
      document.getElementById('psaSelect').value = customer.psa || '';
      document.getElementById('customerNotes').value = customer.notes || '';
      setSelectedPlans(customer.plans || []);
      document.getElementById('saveCustomerBtn').textContent = 'Update customer';

      populateContactsEditor(customer);
      document.getElementById('addContactName').value = '';
      document.getElementById('addContactEmail').value = '';
    }

    function setupCustomerForm() {
      // Plan badge toggles
      document.querySelectorAll('.plan-badge').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('selected');
        });
      });

      const form = document.getElementById('customerForm');
      form.addEventListener('submit', function (e) {
        e.preventDefault();
        const id = document.getElementById('customerId').value || Date.now().toString();
        const companyName = document.getElementById('companyName').value.trim();
        if (!companyName) {
          alert('Company name is required.');
          return;
        }
        const primaryContactName = document.getElementById('primaryContactName').value.trim();
        const primaryContactEmail = document.getElementById('primaryContactEmail').value.trim();
        const tenantUrl = document.getElementById('tenantUrl').value.trim();
        const notes = document.getElementById('customerNotes').value.trim();
        const plans = getSelectedPlans();
        const psa = document.getElementById('psaSelect').value || '';

        const existingIndex = customers.findIndex(c => c.id === id);
        let existing = existingIndex >= 0 ? customers[existingIndex] : null;

        const schedule = existing && existing.schedule ? existing.schedule : {
          frequency: 'monthly',
          lastContactDate: null,
          nextContactDate: null
        };
        const interactions = existing && existing.interactions ? existing.interactions : [];
        let contacts = existing && Array.isArray(existing.contacts) ? existing.contacts.slice() : [];

        // update/create primary contact inside contacts[]
        if (primaryContactName || primaryContactEmail) {
          let primary = contacts.find(c => c.isPrimary);
          if (!primary) {
            primary = {
              id: createId('ct'),
              name: primaryContactName,
              email: primaryContactEmail,
              isPrimary: true
            };
            contacts.unshift(primary);
          } else {
            primary.name = primaryContactName;
            primary.email = primaryContactEmail;
          }
        }

        const updatedCustomer = {
          id,
          companyName,
          tenantUrl,
          plans,
          notes,
          schedule,
          interactions,
          contacts,
          psa
        };

        if (existingIndex >= 0) {
          customers[existingIndex] = updatedCustomer;
        } else {
          customers.push(updatedCustomer);
        }
        saveState();
        clearCustomerForm();
      });

      document.getElementById('clearCustomerBtn').addEventListener('click', function () {
        clearCustomerForm();
      });

      // Add contact button
      document.getElementById('addContactBtn').addEventListener('click', () => {
        const currentId = document.getElementById('customerId').value;
        if (!currentId) {
          alert('Save the customer first before adding contacts.');
          return;
        }
        const customer = customers.find(c => c.id === currentId);
        if (!customer) return;

        const name = document.getElementById('addContactName').value.trim();
        const email = document.getElementById('addContactEmail').value.trim();
        if (!name && !email) {
          alert('Enter at least a name or an email.');
          return;
        }

        customer.contacts = customer.contacts || [];
        const isPrimary = !customer.contacts.length;
        customer.contacts.push({
          id: createId('ct'),
          name,
          email,
          isPrimary
        });

        if (isPrimary) {
          document.getElementById('primaryContactName').value = name;
          document.getElementById('primaryContactEmail').value = email;
        }

        document.getElementById('addContactName').value = '';
        document.getElementById('addContactEmail').value = '';
        saveState();
        populateContactsEditor(customer);
      });
    }

    function renderCustomerList() {
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';

      if (!customers.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.className = 'muted';
        cell.textContent = 'No customers yet. Add one on the left.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }

      const todayStr = getTodayStr();

      customers
        .slice()
        .sort((a, b) => a.companyName.localeCompare(b.companyName))
        .forEach(c => {
          const tr = document.createElement('tr');
          const schedule = c.schedule || {};
          const nextContact = schedule.nextContactDate;
          const nextLabel = nextContact || 'Not scheduled';

          const isDue = nextContact && nextContact <= todayStr;
          const primary = getPrimaryContact(c);

          const plansHtml = c.plans && c.plans.length
            ? c.plans.map(p => `<span class="tag tag-accent">${p}</span>`).join(' ')
            : '<span class="muted">No plans</span>';

          const psaHtml = c.psa
            ? `<span class="tag">PSA: ${c.psa}</span>`
            : '';

          tr.innerHTML = `
            <td>
              <strong>${c.companyName}</strong>
              ${c.tenantUrl ? `<br><a class="text-link" href="${c.tenantUrl}" target="_blank">Tenant portal</a>` : ''}
            </td>
            <td>
              ${primary ? (primary.name || '-') : '-'}
              ${primary && primary.email ? `<br><span class="muted">${primary.email}</span>` : ''}
            </td>
            <td>
              ${plansHtml}
              ${psaHtml}
            </td>
            <td>
              <span class="pill-status ${isDue ? 'due' : 'ok'}">
                ${nextLabel}
              </span>
            </td>
            <td>
              <button class="btn btn-ghost btn-sm" type="button" data-action="editBasics" data-id="${c.id}">Edit</button>
              <button class="btn btn-ghost btn-sm" type="button" data-action="schedule" data-id="${c.id}">Schedule</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      tbody.querySelectorAll('button[data-action="editBasics"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const customer = customers.find(c => c.id === id);
          if (customer) {
            populateCustomerForm(customer);
            document.querySelector('.tab-btn[data-tab="customers"]').click();
          }
        });
      });

      tbody.querySelectorAll('button[data-action="schedule"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const select = document.getElementById('scheduleCustomerSelect');
          select.value = id;
          handleScheduleCustomerChange();
          document.querySelector('.tab-btn[data-tab="dashboard"]').click();
        });
      });
    }

    /* -------- Dashboard: due list, stats, schedule & interaction panel -------- */

    function getDueCustomers() {
      const todayStr = getTodayStr();
      return customers.filter(c => {
        const n = c.schedule && c.schedule.nextContactDate;
        return n && n <= todayStr;
      }).sort((a, b) => {
        const na = a.schedule.nextContactDate;
        const nb = b.schedule.nextContactDate;
        return na.localeCompare(nb);
      });
    }
    function getRecentInteractions(limit = 5) {
      const items = [];
      customers.forEach(c => {
        (c.interactions || []).forEach(i => {
          items.push({
            customerId: c.id,
            companyName: c.companyName,
            date: i.date,
            notes: i.notes || ''
          });
        });
      });

      items.sort((a, b) => b.date.localeCompare(a.date));
      return items.slice(0, limit);
    }

    function renderRecentInteractions() {
      const container = document.getElementById('recentInteractions');
      if (!container) return;

      const items = getRecentInteractions(5);
      container.innerHTML = '';

      if (!items.length) {
        container.innerHTML = '<p class="muted">No interactions logged yet.</p>';
        return;
      }

      const ul = document.createElement('ul');
      ul.className = 'list-compact';

      items.forEach(item => {
        const snippetRaw = item.notes.length > 80
          ? item.notes.slice(0, 80) + '…'
          : item.notes;

        const snippet = snippetRaw.replace(/\n/g, '<br>');

        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${item.companyName}</strong>
          <span class="muted"> · ${item.date}</span><br>
          <span class="muted">${snippet}</span><br>
          <button class="btn btn-ghost btn-sm" type="button"
            data-id="${item.customerId}" data-date="${item.date}">
            Open
          </button>
        `;
        ul.appendChild(li);
      });

      container.appendChild(ul);

      container.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const date = btn.dataset.date;
          openInteractionPanel(id, date);
        });
      });
    }

    function renderDashboardStats() {
      const container = document.getElementById('dashboardStats');
      const total = customers.length;
      const scheduled = customers.filter(c => c.schedule && c.schedule.nextContactDate).length;
      const due = getDueCustomers().length;
      const unscheduled = total - scheduled;

      container.innerHTML = `
        <span class="stat-chip"><strong>${total}</strong> customers</span>
        <span class="stat-chip"><strong>${scheduled}</strong> on schedule</span>
        <span class="stat-chip"><strong>${due}</strong> due / overdue</span>
        <span class="stat-chip"><strong>${unscheduled}</strong> not scheduled</span>
      `;
    }

    function renderDueList() {
      const container = document.getElementById('dueList');
      const dueCustomers = getDueCustomers();
      container.innerHTML = '';

      if (!dueCustomers.length) {
        const p = document.createElement('p');
        p.className = 'muted';
        p.textContent = 'No customers due today. Nice!';
        container.appendChild(p);
        return;
      }

      const ul = document.createElement('ul');
      ul.className = 'list-compact';

      const todayStr = getTodayStr();

      dueCustomers.forEach(c => {
        const li = document.createElement('li');
        const schedule = c.schedule || {};
        const next = schedule.nextContactDate;
        const label = next === todayStr ? 'Today' : `Due ${next}`;
        const primary = getPrimaryContact(c);
        li.innerHTML = `
          <strong>${c.companyName}</strong>
          <br>
          <span class="muted">${label} · ${schedule.frequency || 'monthly'}</span>
          <br>
          ${primary ? `<span class="muted">${primary.name || ''}${primary && primary.email ? ' · ' + primary.email : ''}</span><br>` : ''}
          <button class="btn btn-primary btn-sm" type="button" data-id="${c.id}" data-action="logContact">Log contact</button>
        `;
        ul.appendChild(li);
      });

      container.appendChild(ul);

      container.querySelectorAll('button[data-action="logContact"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          openInteractionPanel(id, new Date());
        });
      });
    }

    function renderScheduleSelectOptions() {
      const select = document.getElementById('scheduleCustomerSelect');
      const current = select.value;
      select.innerHTML = '<option value="">Select a customer…</option>';
      customers
        .slice()
        .sort((a, b) => a.companyName.localeCompare(b.companyName))
        .forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.companyName;
          select.appendChild(opt);
        });

      if (current && customers.some(c => c.id === current)) {
        select.value = current;
      }
    }

     function handleScheduleCustomerChange() {
      const select = document.getElementById('scheduleCustomerSelect');
      const id = select.value;
      const scheduleDetails = document.getElementById('scheduleDetails');
      const freqSelect = document.getElementById('frequencySelect');
      const nextInput = document.getElementById('nextContactInput');

      if (!id) {
        scheduleDetails.textContent = 'No customer selected.';
        freqSelect.value = 'monthly';
        nextInput.value = '';
        return;
      }

      const customer = customers.find(c => c.id === id);
      if (!customer) return;

      const schedule = customer.schedule || {};
      const interactions = customer.interactions || [];
      const lastInteraction = interactions.slice().sort((a, b) => b.date.localeCompare(a.date))[0];

      // keep form fields in sync
      freqSelect.value = schedule.frequency || 'monthly';
      nextInput.value = schedule.nextContactDate || '';

      const lastText = lastInteraction
        ? `Last interaction on ${lastInteraction.date}: "${lastInteraction.notes.slice(0, 80)}${lastInteraction.notes.length > 80 ? '…' : ''}"`
        : 'No interactions logged yet.';

      const nextText = schedule.nextContactDate
        ? `Next scheduled contact on ${schedule.nextContactDate}.`
        : 'Not scheduled yet.';

      const plansHtml = customer.plans && customer.plans.length
        ? customer.plans.map(p => `<span class="tag tag-accent">${p}</span>`).join(' ')
        : '<span class="muted">No plans recorded</span>';

      const psaHtml = customer.psa
        ? `<span class="tag">PSA: ${customer.psa}</span>`
        : '';

      scheduleDetails.innerHTML = `
        <div>${nextText}</div>
        <div class="muted" style="margin-top:2px;">${lastText}</div>
        <div style="margin-top:4px;">${plansHtml} ${psaHtml}</div>
      `;
    }


    function setupSchedulePanel() {
      const select = document.getElementById('scheduleCustomerSelect');
      select.addEventListener('change', handleScheduleCustomerChange);

      document.getElementById('saveScheduleBtn').addEventListener('click', () => {
        const id = select.value;
        if (!id) {
          alert('Select a customer first.');
          return;
        }
        const customer = customers.find(c => c.id === id);
        if (!customer) return;

        const freq = document.getElementById('frequencySelect').value || 'monthly';
        let next = document.getElementById('nextContactInput').value;

        if (!next) {
          next = computeNextContactDate(new Date(), freq);
        }

        customer.schedule = customer.schedule || {};
        customer.schedule.frequency = freq;
        customer.schedule.nextContactDate = next;
        saveState();
      });
    }

    function renderInteractionHistory(customer, container) {
      container.innerHTML = '';

      const interactions = (customer.interactions || []).slice().sort((a, b) => b.date.localeCompare(a.date));

      if (!interactions.length) {
        container.innerHTML = '<p class="muted">No previous interactions yet.</p>';
        return;
      }

      interactions.forEach((interaction, idx) => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div class="history-item-header">
            <span>${interaction.date}</span>
            <button class="btn btn-ghost btn-sm" type="button" data-index="${idx}">Edit</button>
          </div>
          <div>${interaction.notes.replace(/\n/g, '<br>')}</div>
        `;
        container.appendChild(div);
      });

      container.querySelectorAll('button[data-index]').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.dataset.index);
          const interactionsSorted = (customer.interactions || []).slice().sort((a, b) => b.date.localeCompare(a.date));
          const target = interactionsSorted[idx];
          if (!target) return;

          const newText = prompt('Edit note from ' + target.date, target.notes);
          if (newText === null) return;

          const originalIndex = customer.interactions.findIndex(i => i.date === target.date && i.notes === target.notes);
          if (originalIndex >= 0) {
            customer.interactions[originalIndex].notes = newText.trim();
            saveState();
            openInteractionPanel(customer.id, target.date);
          }
        });
      });
    }

    function buildContactsHtml(customer) {
      const primary = getPrimaryContact(customer);
      const others = (customer.contacts || []).filter(c => !c.isPrimary && (c.name || c.email));
      let html = '';

      if (primary) {
        html += (primary.name || '') + (primary.email ? ' · ' + primary.email : '');
      }

      if (others.length) {
        const otherText = others
          .map(o => (o.name || '') + (o.email ? ' · ' + o.email : ''))
          .join('; ');
        html += `<br>Others: ${otherText}`;
      }

      return html || 'No contact info';
    }

    function openInteractionPanel(customerId, dateForInteraction) {
      const interactionPanel = document.getElementById('interactionPanel');
      const customer = customers.find(c => c.id === customerId);
      if (!customer) return;

      const dateStr = typeof dateForInteraction === 'string'
        ? dateForInteraction
        : formatDate(dateForInteraction || new Date());

      const interactions = customer.interactions || [];
      const lastInteraction = interactions.slice().sort((a, b) => b.date.localeCompare(a.date))[0];

      const lastInteractionHtml = lastInteraction
        ? `
        <div class="history-item">
          <div class="history-item-header">
            <span>Last interaction · ${lastInteraction.date}</span>
          </div>
          <div>${lastInteraction.notes.replace(/\n/g, '<br>')}</div>
        </div>`
        : '<p class="muted">No previous discussions logged.</p>';

      const plansHtml = customer.plans && customer.plans.length
        ? customer.plans.map(p => `<span class="tag tag-accent">${p}</span>`).join(' ')
        : '<span class="muted">No plans recorded</span>';

      const psaHtml = customer.psa
        ? `<span class="tag">PSA: ${customer.psa}</span>`
        : '';

      const generalNotes = customer.notes || '';

      interactionPanel.innerHTML = `
        <div style="margin-bottom:6px;">
          <div><strong>${customer.companyName}</strong></div>
          <div class="muted" style="font-size:11px;">
            ${buildContactsHtml(customer)}
            ${customer.tenantUrl ? `<br><a class="text-link" href="${customer.tenantUrl}" target="_blank">Tenant portal</a>` : ''}
          </div>
          <div style="margin-top:4px;">${plansHtml} ${psaHtml}</div>
        </div>
        <div class="divider"></div>
        <div>
          <strong style="font-size:13px;">Customer notes</strong>
          <p class="muted" style="margin-top:2px;">${generalNotes ? generalNotes.replace(/\n/g, '<br>') : 'None yet.'}</p>
        </div>
        <div class="divider"></div>
        <div>
          <strong style="font-size:13px;">Last discussion</strong>
          ${lastInteractionHtml}
        </div>
        <div class="divider"></div>
        <div>
          <label for="newInteractionNotes">New notes for ${dateStr}</label>
          <textarea id="newInteractionNotes" placeholder="What did you discuss with ${customer.companyName}?"></textarea>
          <div style="margin-top:8px;">
            <button class="btn btn-primary btn-sm" type="button" id="saveInteractionBtn">Save notes & update schedule</button>
          </div>
        </div>
        <div class="divider"></div>
        <div>
          <strong style="font-size:13px;">History</strong>
          <div id="interactionHistory" class="history-list" style="margin-top:4px;"></div>
        </div>
      `;

      const historyContainer = document.getElementById('interactionHistory');
      renderInteractionHistory(customer, historyContainer);

      const saveBtn = document.getElementById('saveInteractionBtn');
      saveBtn.addEventListener('click', () => {
        const textArea = document.getElementById('newInteractionNotes');
        const text = textArea.value.trim();
        if (!text) {
          alert('Please enter some notes before saving.');
          return;
        }

        customer.interactions = customer.interactions || [];
        customer.interactions.push({
          date: dateStr,
          notes: text
        });

        customer.schedule = customer.schedule || {
          frequency: 'monthly',
          lastContactDate: null,
          nextContactDate: null
        };

        customer.schedule.lastContactDate = dateStr;
        customer.schedule.nextContactDate = computeNextContactDate(parseDate(dateStr), customer.schedule.frequency || 'monthly');

        textArea.value = '';
        saveState();
        openInteractionPanel(customer.id, dateStr);
      });

      document.querySelector('.tab-btn[data-tab="dashboard"]').click();
    }

    /* -------- Calendar -------- */

    function setupCalendarNav() {
      const today = new Date();
      currentCalendarMonth = today.getMonth();
      currentCalendarYear = today.getFullYear();

      document.getElementById('prevMonthBtn').addEventListener('click', () => {
        currentCalendarMonth--;
        if (currentCalendarMonth < 0) {
          currentCalendarMonth = 11;
          currentCalendarYear--;
        }
        renderCalendar();
      });

      document.getElementById('nextMonthBtn').addEventListener('click', () => {
        currentCalendarMonth++;
        if (currentCalendarMonth > 11) {
          currentCalendarMonth = 0;
          currentCalendarYear++;
        }
        renderCalendar();
      });

      document.getElementById('todayMonthBtn').addEventListener('click', () => {
        const now = new Date();
        currentCalendarMonth = now.getMonth();
        currentCalendarYear = now.getFullYear();
        renderCalendar();
      });
    }

    function renderCalendar() {
      const monthNames = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const label = document.getElementById('calendarMonthLabel');
      label.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

      const grid = document.getElementById('calendarGridDays');
      grid.innerHTML = '';

      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const startWeekday = firstDay.getDay(); // 0 = Sunday
      const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();

      for (let i = 0; i < startWeekday; i++) {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';
        cell.style.visibility = 'hidden';
        grid.appendChild(cell);
      }

      const todayStr = getTodayStr();

      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentCalendarYear, currentCalendarMonth, day);
        const dateStr = formatDate(dateObj);

        const cell = document.createElement('div');
        cell.className = 'calendar-cell';

        const scheduledCustomers = customers.filter(c => {
          const n = c.schedule && c.schedule.nextContactDate;
          return n === dateStr;
        });

        if (scheduledCustomers.length) {
          cell.classList.add('has-contacts');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = day;
        cell.appendChild(dayNumber);

        if (dateStr === todayStr) {
          const pill = document.createElement('span');
          pill.className = 'pill';
          pill.style.position = 'absolute';
          pill.style.bottom = '4px';
          pill.style.left = '4px';
          pill.textContent = 'Today';
          cell.appendChild(pill);
        }

        if (scheduledCustomers.length) {
          const dot = document.createElement('div');
          dot.className = 'calendar-dot';
          cell.appendChild(dot);

          const mini = document.createElement('div');
          mini.className = 'mini-label';
          mini.textContent = `${scheduledCustomers.length} contact${scheduledCustomers.length > 1 ? 's' : ''}`;
          cell.appendChild(mini);

          cell.addEventListener('click', () => {
            showDayDetails(dateStr, scheduledCustomers);
          });
        }

        grid.appendChild(cell);
      }
    }

    function showDayDetails(dateStr, scheduledCustomers) {
      const title = document.getElementById('dayDetailsTitle');
      const count = document.getElementById('dayDetailsCount');
      const content = document.getElementById('dayDetailsContent');

      title.textContent = `Contacts for ${dateStr}`;
      count.textContent = `${scheduledCustomers.length} customer${scheduledCustomers.length !== 1 ? 's' : ''}`;

      if (!scheduledCustomers.length) {
        content.innerHTML = '<p class="muted">No customers scheduled for this day.</p>';
        return;
      }

      const ul = document.createElement('ul');
      ul.className = 'list-compact';

      scheduledCustomers
        .slice()
        .sort((a, b) => a.companyName.localeCompare(b.companyName))
        .forEach(c => {
          const li = document.createElement('li');
          const schedule = c.schedule || {};
          const freq = schedule.frequency || 'monthly';
          const last = (c.interactions || []).slice().sort((a, b) => b.date.localeCompare(a.date))[0];
          const lastSnippet = last ? last.notes.slice(0, 60) + (last.notes.length > 60 ? '…' : '') : 'No previous notes';

          li.innerHTML = `
            <strong>${c.companyName}</strong>
            <br>
            <span class="muted">Frequency: ${freq}</span>
            <br>
            <span class="muted">Last: ${last ? last.date : '—'} · ${lastSnippet}</span>
            <br>
            <button class="btn btn-primary btn-sm" type="button" data-id="${c.id}">Open notes</button>
          `;
          ul.appendChild(li);
        });

      content.innerHTML = '';
      content.appendChild(ul);

      content.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          openInteractionPanel(id, dateStr);
        });
      });
    }

    /* -------- Overview tab -------- */

    function renderOverviewCustomerList() {
      const listEl = document.getElementById('overviewCustomerList');
      const searchInput = document.getElementById('overviewSearchInput');
      if (!listEl || !searchInput) return;

      const term = searchInput.value.trim().toLowerCase();
      listEl.innerHTML = '';

      const filtered = customers
        .slice()
        .sort((a, b) => a.companyName.localeCompare(b.companyName))
        .filter(c => !term || c.companyName.toLowerCase().includes(term));

      if (!filtered.length) {
        listEl.innerHTML = '<p class="muted">No customers match this search.</p>';
        return;
      }

      filtered.forEach(c => {
        const div = document.createElement('div');
        div.className = 'overview-item';
        if (c.id === selectedOverviewCustomerId) {
          div.classList.add('selected');
        }
        const latest = (c.interactions || []).slice().sort((a, b) => b.date.localeCompare(a.date))[0];

        div.innerHTML = `
          <div><strong>${c.companyName}</strong></div>
          <div class="muted">
            ${latest ? `Last meeting: ${latest.date}` : 'No meetings logged'}
          </div>
        `;
        div.addEventListener('click', () => {
          selectedOverviewCustomerId = c.id;
          renderOverviewCustomerList();
          renderOverviewDetails();
        });
        listEl.appendChild(div);
      });
    }

    function renderOverviewDetails() {
      const container = document.getElementById('overviewDetails');
      if (!container) return;

      if (!customers.length) {
        container.innerHTML = '<p class="muted">No customers yet. Add some in the Customers tab.</p>';
        return;
      }

      if (!selectedOverviewCustomerId) {
        selectedOverviewCustomerId = customers[0].id;
      }

      const customer = customers.find(c => c.id === selectedOverviewCustomerId);
      if (!customer) {
        container.innerHTML = '<p class="muted">Select a customer on the left to see their history.</p>';
        return;
      }

      const plansHtml = customer.plans && customer.plans.length
        ? customer.plans.map(p => `<span class="tag tag-accent">${p}</span>`).join(' ')
        : '<span class="muted">No plans recorded</span>';

      const psaHtml = customer.psa
        ? `<span class="tag">PSA: ${customer.psa}</span>`
        : '';

      const interactions = (customer.interactions || []).slice().sort((a, b) => b.date.localeCompare(a.date));

      const historyHtml = interactions.length
        ? interactions.map(i => `
          <div class="history-item">
            <div class="history-item-header">
              <span>${i.date}</span>
            </div>
            <div>${i.notes.replace(/\n/g, '<br>')}</div>
          </div>
        `).join('')
        : '<p class="muted">No meetings logged yet. Log your first notes from the Dashboard.</p>';

      container.innerHTML = `
        <div style="margin-bottom:8px;">
          <div><strong>${customer.companyName}</strong></div>
          <div class="muted" style="font-size:11px;">
            ${buildContactsHtml(customer)}
            ${customer.tenantUrl ? `<br><a class="text-link" href="${customer.tenantUrl}" target="_blank">Tenant portal</a>` : ''}
          </div>
          <div style="margin-top:4px;">${plansHtml} ${psaHtml}</div>
          ${customer.notes ? `<div class="divider"></div><div class="muted" style="font-size:12px;">${customer.notes.replace(/\n/g, '<br>')}</div>` : ''}
        </div>
        <div class="divider"></div>
        <div>
          <strong style="font-size:13px;">Meeting timeline</strong>
          <div class="history-list" style="margin-top:4px; max-height:220px;">
            ${historyHtml}
          </div>
        </div>
      `;
    }

    function setupOverviewTab() {
      const input = document.getElementById('overviewSearchInput');
      if (input) {
        input.addEventListener('input', renderOverviewCustomerList);
      }
    }

    function renderOverviewTab() {
      renderOverviewCustomerList();
      renderOverviewDetails();
    }

    /* -------- Tasks tab -------- */

    function setupTasksTab() {
      const form = document.getElementById('taskForm');
      if (form) {
        form.addEventListener('submit', e => {
          e.preventDefault();
          const customerSelect = document.getElementById('taskCustomerSelect');
          const descEl = document.getElementById('taskDescription');
          const dueEl = document.getElementById('taskDueDate');

          const customerId = customerSelect.value || null;
          const description = (descEl.value || '').trim();
          const dueDate = dueEl.value || null;

          if (!description) {
            alert('Please enter a task description.');
            return;
          }

          let companyName = 'General';
          if (customerId) {
            const c = customers.find(c => c.id === customerId);
            if (c) companyName = c.companyName;
          }

          const task = {
            id: Date.now().toString(),
            customerId,
            companyName,
            description,
            dueDate,
            completed: false,
            createdAt: getTodayStr(),
            completedAt: null
          };

          tasks.push(task);
          descEl.value = '';
          dueEl.value = '';
          saveState();
        });
      }

      document.querySelectorAll('.task-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          taskFilter = btn.dataset.filter;
          document.querySelectorAll('.task-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderTasksTab();
        });
      });
    }

    function renderTaskCustomerOptions() {
      const select = document.getElementById('taskCustomerSelect');
      if (!select) return;
      const current = select.value;

      select.innerHTML = '<option value="">Select a customer…</option>';
      customers
        .slice()
        .sort((a, b) => a.companyName.localeCompare(b.companyName))
        .forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.id;
          opt.textContent = c.companyName;
          select.appendChild(opt);
        });

      if (current && customers.some(c => c.id === current)) {
        select.value = current;
      }
    }

    function renderTaskStats() {
      const container = document.getElementById('taskStats');
      if (!container) return;

      const total = tasks.length;
      const open = tasks.filter(t => !t.completed).length;
      const completed = total - open;

      container.innerHTML = `
        <span class="stat-chip"><strong>${total}</strong> total</span>
        <span class="stat-chip"><strong>${open}</strong> open</span>
        <span class="stat-chip"><strong>${completed}</strong> completed</span>
      `;
    }

    function renderTaskList() {
      const tbody = document.getElementById('taskTableBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      let filtered = tasks.slice();
      if (taskFilter === 'open') filtered = filtered.filter(t => !t.completed);
      if (taskFilter === 'completed') filtered = filtered.filter(t => t.completed);

      filtered.sort((a, b) => {
        const aDue = a.dueDate || '9999-12-31';
        const bDue = b.dueDate || '9999-12-31';
        if (aDue === bDue) return a.createdAt.localeCompare(b.createdAt);
        return aDue.localeCompare(bDue);
      });

      if (!filtered.length) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.className = 'muted';
        cell.textContent = 'No tasks in this view.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }

      const todayStr = getTodayStr();

      filtered.forEach(t => {
        const tr = document.createElement('tr');
        const isOverdue = t.dueDate && !t.completed && t.dueDate < todayStr;

        tr.innerHTML = `
          <td>${t.companyName || 'General'}</td>
          <td>${t.description.replace(/\n/g, '<br>')}</td>
          <td>
            ${t.dueDate
              ? `<span class="pill-status ${isOverdue ? 'due' : 'ok'}">${t.dueDate}</span>`
              : '<span class="muted">No due date</span>'}
          </td>
          <td>
            <span class="pill-status ${t.completed ? 'ok' : ''}">
              ${t.completed ? 'Completed' : 'Open'}
            </span>
          </td>
          <td>
            <button class="btn btn-ghost btn-sm" type="button" data-action="toggle" data-id="${t.id}">
              ${t.completed ? 'Reopen' : 'Complete'}
            </button>
            <button class="btn btn-ghost btn-sm" type="button" data-action="delete" data-id="${t.id}">
              Delete
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-action="toggle"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          const t = tasks.find(t => t.id === id);
          if (!t) return;
          t.completed = !t.completed;
          t.completedAt = t.completed ? getTodayStr() : null;
          saveState();
        });
      });

      tbody.querySelectorAll('button[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id;
          if (!confirm('Delete this task?')) return;
          tasks = tasks.filter(t => t.id !== id);
          saveState();
        });
      });
    }

    function renderTasksTab() {
      renderTaskCustomerOptions();
      renderTaskStats();
      renderTaskList();
    }

    /* -------- Render all -------- */

       function renderAll() {
      renderCustomerList();
      renderDashboardStats();
      renderDueList();
      renderRecentInteractions();
      renderScheduleSelectOptions();
      handleScheduleCustomerChange();
      renderCalendar();
      renderOverviewTab();
      renderTasksTab();
    }


    /* -------- Init -------- */

      document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      setupCustomerForm();
      setupSchedulePanel();
      setupCalendarNav();
      setupOverviewTab();
      setupTasksTab();
      setupBackupControls();
      loadState();
      renderAll();
    });

  })();
</script>
</body>
</html>
